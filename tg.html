<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bet365 Live xT & Momentum-kalkylator ‚Äì Expected Threat + Monte Carlo</title>
  <style>
    :root {
      --blue:#004aad;
      --green:#22c55e;
      --amber:#f59e0b;
      --bg:#f9f9f9;
      --card:#ffffff;
      --muted:#eef6ff;
      --border:#e5e7eb;
      --ink:#1a1a1a;
    }
    body {font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px;}
    h1 {color:var(--blue);}
    .grid2 {display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .grid3 {display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .box {background:var(--card); border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:20px;}
    h3 {margin:8px 0 6px; color:var(--blue)}
    label {display:block; margin-top:8px; font-size:14px;}
    input[type=number] {width:100%; padding:6px; margin-top:3px; border:1px solid #ccc; border-radius:6px; font-size:14px;}
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      margin: 5px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    .btn.secondary{background:#e5e7eb; color:#111}
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px 0;
      gap: 10px;
    }
    .saved-list {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .saved-item {
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .saved-item:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
    }
    .saved-item-header {
      font-weight: bold;
      color: #1e293b;
      margin-bottom: 5px;
    }
    .saved-item-details {
      font-size: 12px;
      color: #64748b;
    }
    .result {margin-top:15px; padding:15px; background:var(--muted); border-left:4px solid var(--blue); display:none; border-radius:8px;}
    .bar-container {background:#eee; border-radius:6px; height:22px; width:100%; margin:6px 0; position:relative; overflow:hidden}
    .bar {height:100%;}
    .bar.poisson {background:var(--blue);}
    .bar.mc {background:var(--green); position:absolute; top:0; left:0; opacity:0.75;}
    table {width:100%; border-collapse:collapse; margin-top:6px; font-size:14px;}
    th, td {text-align:left; padding:6px 4px; border-bottom:1px solid var(--border);}
    th {color:#333}
    .mono{font-variant-numeric: tabular-nums}
    .pill{background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:13px;}
    .kpi {display:flex; gap:12px; flex-wrap:wrap; margin:6px 0 12px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div style="text-align: center; margin-bottom: 20px;">
    <a href="index.html" style="display: inline-block; background: #6b7280; color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; margin-bottom: 15px;">‚Üê Tillbaka till huvudsidan</a>
  </div>
  
  <h1>‚öΩ Bet365 Live xT & Momentum-kalkylator</h1>
  <p>Avancerad live-kalkylator som anv√§nder <b>xT (F√∂rv√§ntad Fara)</b> och <b>momentum-modeller</b> baserat p√• Bet365-statistik. Ber√§knar r√§ttvisa odds med Monte Carlo-simulering och markerar <b>V√ÑRDE</b> n√§r marknadsodds √∂verstiger modellens odds.</p>

  <div class="grid2">
    <!-- INPUTS -->
    <div class="box">
      <h3>Match & statistik</h3>
      <div class="grid3">
        <label>Minut<input id="minute" type="number" value="78"></label>
        <label>Till√§gg<input id="stopp" type="number" value="5"></label>
        <label>MC-simuleringar<input id="sims" type="number" value="10000"></label>
      </div>
      <div class="grid3">
        <label>Hemmalag m√•l<input id="sh" type="number" value="1"></label>
        <label>Bortalag m√•l<input id="sa" type="number" value="1"></label>
        <label>Gula kort<input id="yc" type="number" value="3"></label>
      </div>
      <div class="grid3">
        <label>R√∂da Hemma<input id="red_h" type="number" value="0"></label>
        <label>R√∂da Borta<input id="red_a" type="number" value="0"></label>
      </div>

      <h3>Bet365 totalsiffror</h3>
      <div class="grid3">
        <label>Skott H<input id="shots_h" type="number" value="12"></label>
        <label>Skott p√• m√•l H<input id="sot_h" type="number" value="5"></label>
        <label>H√∂rn H<input id="corners_h" type="number" value="6"></label>
      </div>
      <label>Bollinnehav H<input id="da_h" type="number" value="65"></label>

      <div class="grid3">
        <label>Skott B<input id="shots_a" type="number" value="9"></label>
        <label>Skott p√• m√•l B<input id="sot_a" type="number" value="3"></label>
        <label>H√∂rn B<input id="corners_a" type="number" value="4"></label>
      </div>
      <label>Bollinnehav B<input id="da_a" type="number" value="55"></label>

      <h3>Marknadsodds (fr√•n Bet365)</h3>
      <div class="grid3">
        <label>√ñver 0.5<input id="mkt_over05" type="number" step="0.01" value="1.70"></label>
        <label>√ñver 1.5<input id="mkt_over15" type="number" step="0.01" value="2.30"></label>
        <span></span>
      </div>
      <div class="grid3">
        <label>Hemma<input id="mkt_home" type="number" step="0.01" value="2.20"></label>
        <label>Oavgjort<input id="mkt_draw" type="number" step="0.01" value="3.40"></label>
        <label>Borta<input id="mkt_away" type="number" step="0.01" value="3.10"></label>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="runCalc()">Ber√§kna</button>
        <button class="btn" onclick="saveCalculation()" style="background:#22c55e;">üíæ Spara</button>
        <button class="btn" onclick="loadCalculation()" style="background:#3b82f6;">üìÇ Ladda</button>
        <button class="btn" onclick="showSavedList()" style="background:#8b5cf6;">üìã Lista</button>
      </div>
    </div>

    <!-- RESULTAT -->
    <div class="box">
      <h3>Resultat & Value-check</h3>
      <div id="out" class="result"></div>
    
    <div id="savedList" class="saved-list" style="display:none;">
      <h4>üíæ Sparade ber√§kningar</h4>
      <div id="savedItems"></div>
    </div>
  </div>
  </div>

<script>
// xT (Expected Threat) och Momentum-baserad Live Kalkylator
function factorial(n){let r=1;for(let i=2;i<=n;i++)r*=i;return r;}
function pois(k,lam){return Math.exp(-lam)*Math.pow(lam,k)/(k?factorial(k):1);}
function pct(x){return (100*x).toFixed(1)+"%";}
function fair(p){return p>0?(1/p).toFixed(2):"‚àû";}

// xT-modell: Ber√§knar Expected Threat baserat p√• skottstatistik och positioner
function calculatexT(shots, sot, corners, possession, goals, minute) {
  // Grundl√§ggande xT-v√§rden baserat p√• skottstatistik
  const shotAccuracy = shots > 0 ? sot / shots : 0;
  const conversionRate = sot > 0 ? goals / sot : 0;
  
  // xT-komponenter
  const shotThreat = shots * 0.08; // Grundv√§rde per skott
  const accuracyBonus = shotAccuracy * 0.15; // Bonus f√∂r tr√§ffs√§kerhet
  const conversionBonus = conversionRate * 0.25; // Bonus f√∂r m√•leffektivitet
  const cornerThreat = corners * 0.12; // H√∂rnthreat
  const possessionThreat = (possession / 100) * 0.1; // Bollinnehavsthreat
  
  return shotThreat + accuracyBonus + conversionBonus + cornerThreat + possessionThreat;
}

// Momentum-modell: V√§ger senaste h√§ndelser tyngre
function calculateMomentum(currentGoals, xT, minute, redCards, yellowCards) {
  // Tidsbaserad viktning - senare i matchen = h√∂gre vikt
  const timeWeight = Math.min(1.5, 0.5 + (minute / 90));
  
  // M√•lmomentum - senaste m√•l p√•verkar framtida sannolikhet
  const goalMomentum = currentGoals > 0 ? Math.log(currentGoals + 1) * 0.3 : 0;
  
  // Kort-p√•verkan p√• momentum
  const cardPenalty = (redCards * 0.4) + (yellowCards * 0.05);
  
  // Kombinerat momentum
  const momentum = (xT * timeWeight + goalMomentum) * (1 - cardPenalty);
  
  return Math.max(0, momentum);
}

// Avancerad m√•lfrekvens baserad p√• xT och momentum
function calculateAdvancedRate(homeStats, awayStats, minute) {
  const { shots: shotsH, sot: sotH, corners: cornersH, possession: daH, goals: sh, red: redH, yellow: ycH } = homeStats;
  const { shots: shotsA, sot: sotA, corners: cornersA, possession: daA, goals: sa, red: redA, yellow: ycA } = awayStats;
  
  // Ber√§kna xT f√∂r b√•da lagen
  const xTHome = calculatexT(shotsH, sotH, cornersH, daH, sh, minute);
  const xTAway = calculatexT(shotsA, sotA, cornersA, daA, sa, minute);
  
  // Ber√§kna momentum f√∂r b√•da lagen
  const momentumHome = calculateMomentum(sh, xTHome, minute, redH, ycH);
  const momentumAway = calculateMomentum(sa, xTAway, minute, redA, ycA);
  
  // Normalisera och konvertera till m√•lfrekvens per minut
  const totalThreat = momentumHome + momentumAway;
  const baseRate = Math.max(0.01, totalThreat * 0.15); // Grundfrekvens
  
  // Justera f√∂r matchsituation
  const situationalMultiplier = minute > 75 ? 1.2 : minute < 30 ? 0.8 : 1.0;
  
  return {
    homeRate: (momentumHome / (momentumHome + momentumAway + 0.01)) * baseRate * situationalMultiplier,
    awayRate: (momentumAway / (momentumHome + momentumAway + 0.01)) * baseRate * situationalMultiplier,
    totalRate: baseRate * situationalMultiplier,
    xTHome,
    xTAway,
    momentumHome,
    momentumAway
  };
}

function runCalc(){
  const gv=id=>parseFloat(document.getElementById(id).value||0);
  const minute=gv("minute"), stopp=gv("stopp"), sims=gv("sims");
  const sh=gv("sh"), sa=gv("sa"), yc=gv("yc"), redH=gv("red_h"), redA=gv("red_a");
  const shotsH=gv("shots_h"), sotH=gv("sot_h"), cornersH=gv("corners_h"), daH=gv("da_h");
  const shotsA=gv("shots_a"), sotA=gv("sot_a"), cornersA=gv("corners_a"), daA=gv("da_a");

  // Marknadsodds
  const mkt_over05=gv("mkt_over05"), mkt_over15=gv("mkt_over15");
  const mkt_home=gv("mkt_home"), mkt_draw=gv("mkt_draw"), mkt_away=gv("mkt_away");

  const R = Math.max(0,(90+stopp)-minute);
  
  // F√∂rbered data f√∂r avancerad modell
  const homeStats = {
    shots: shotsH, sot: sotH, corners: cornersH, possession: daH,
    goals: sh, red: redH, yellow: yc * 0.6 // Anta 60% av gula kort √§r hemmalag
  };
  const awayStats = {
    shots: shotsA, sot: sotA, corners: cornersA, possession: daA,
    goals: sa, red: redA, yellow: yc * 0.4 // Anta 40% av gula kort √§r bortalag
  };
  
  // Ber√§kna avancerade rates med xT och momentum
  const rates = calculateAdvancedRate(homeStats, awayStats, minute);

  // Anv√§nd den nya xT och momentum-baserade modellen
  const lamH = rates.homeRate * R;
  const lamA = rates.awayRate * R;

  // Poisson-ber√§kningar
  let noGoal=0, over05=0, over15=0, H=0, X=0, A=0;
  const MAX = 15; // √ñka f√∂r b√§ttre precision
  
  // Kontrollera redan gjorda m√•l f√∂r korrekta ber√§kningar
  const currentTotalGoals = sh + sa;
  
  for(let i=0; i<=MAX; i++){
    for(let j=0; j<=MAX; j++){
      const p = pois(i, lamH) * pois(j, lamA);
      
      // Totala m√•l i hela matchen (redan gjorda + framtida)
      const totalMatchGoals = currentTotalGoals + i + j;
      
      if(i===0 && j===0) noGoal += p;
      if(totalMatchGoals >= 1) over05 += p;
      if(totalMatchGoals >= 2) over15 += p;
      
      const fh = sh + i;
      const fa = sa + j;
      if(fh > fa) H += p;
      else if(fh === fa) X += p;
      else A += p;
    }
  }

  // Intelligenta rekommendationer f√∂r fler m√•l
  function getGoalRecommendations(currentGoals, xT, momentum, minute) {
    const recommendations = [];
    
    if(currentGoals > 2) {
      // H√∂g m√•lmatch - rekommendera fler m√•l
      if(xT > 1.8 && momentum > 0.6) {
        recommendations.push({
          type: 'STARK',
          market: '√ñver 3.5 m√•l',
          confidence: 85,
          reason: `Mycket h√∂g xT (${xT.toFixed(2)}) och stark momentum (${(momentum*100).toFixed(0)}%) i m√•lrik match`
        });
        
        if(minute < 70) {
          recommendations.push({
            type: 'STARK',
            market: '√ñver 4.5 m√•l',
            confidence: 75,
            reason: `Tid kvar (${90-minute} min) och extremt h√∂g m√•lfrekvens`
          });
        }
      } else if(xT > 1.4 && momentum > 0.4) {
        recommendations.push({
          type: 'MEDIUM',
          market: '√ñver 3.5 m√•l',
          confidence: 70,
          reason: `God xT (${xT.toFixed(2)}) och positiv momentum i m√•lrik match`
        });
      }
      
      // N√§sta m√•l rekommendationer
      if(momentum > 0.7) {
        recommendations.push({
          type: 'STARK',
          market: 'N√§sta m√•l inom 15 min',
          confidence: 80,
          reason: `Mycket stark momentum (${(momentum*100).toFixed(0)}%) indikerar snabbt n√§sta m√•l`
        });
      }
      
      // B√•da lagen att g√∂ra m√•l
      if(xT > 1.6) {
        recommendations.push({
          type: 'MEDIUM',
          market: 'B√•da lagen g√∂r m√•l',
          confidence: 75,
          reason: `H√∂g xT (${xT.toFixed(2)}) i m√•lrik match gynnar b√•da lagen`
        });
      }
    }
    
    return recommendations;
  }

  // Monte Carlo-simulering
  function runMonteCarlo(lamH, lamA, sims, currentH, currentA) {
    let mc_noGoal=0, mc_over05=0, mc_over15=0, mc_H=0, mc_X=0, mc_A=0;
    
    for(let sim=0; sim<sims; sim++) {
      // Generera Poisson-f√∂rdelade m√•l f√∂r √•terst√•ende tid
      const goalsH = poissonRandom(lamH);
      const goalsA = poissonRandom(lamA);
      
      const finalH = currentH + goalsH;
      const finalA = currentA + goalsA;
      
      // Totala m√•l i hela matchen
      const totalMatchGoals = finalH + finalA;
      
      if(goalsH === 0 && goalsA === 0) mc_noGoal++;
      if(totalMatchGoals >= 1) mc_over05++;
      if(totalMatchGoals >= 2) mc_over15++;
      
      if(finalH > finalA) mc_H++;
      else if(finalH === finalA) mc_X++;
      else mc_A++;
    }
    
    return {
      noGoal: mc_noGoal/sims,
      over05: mc_over05/sims,
      over15: mc_over15/sims,
      H: mc_H/sims,
      X: mc_X/sims,
      A: mc_A/sims
    };
  }

  // Poisson slumpgenerator
  function poissonRandom(lambda) {
    if(lambda < 30) {
      let L = Math.exp(-lambda);
      let k = 0;
      let p = 1;
      do {
        k++;
        p *= Math.random();
      } while (p > L);
      return k - 1;
    } else {
      // Approximation f√∂r stora lambda
      return Math.max(0, Math.round(lambda + Math.sqrt(lambda) * (Math.random() - 0.5) * 2.5));
    }
  }

  const mc = runMonteCarlo(lamH, lamA, sims, sh, sa);

  // Generera intelligenta rekommendationer
  // currentTotalGoals redan deklarerad tidigare i Poisson-sektionen
  const avgxT = (rates.xTHome + rates.xTAway) / 2;
  const avgMomentum = (rates.momentumHome + rates.momentumAway) / 2;
  const recommendations = getGoalRecommendations(currentTotalGoals, avgxT, avgMomentum, minute);

  // Fair odds f√∂r b√•da metoderna
  const f_noGoal = fair(noGoal);
  const f_over05 = fair(over05);
  const f_over15 = fair(over15);
  const f_H = fair(H);
  const f_X = fair(X);
  const f_A = fair(A);
  
  const mc_f_noGoal = fair(mc.noGoal);
  const mc_f_over05 = fair(mc.over05);
  const mc_f_over15 = fair(mc.over15);
  const mc_f_H = fair(mc.H);
  const mc_f_X = fair(mc.X);
  const mc_f_A = fair(mc.A);

  // Value check
  const valueCheck = (market, fair) => {
    if(!market || market <= 1) return '-';
    const edge = ((market - fair) / fair * 100);
    if(edge > 5) return `<span style="color:green; font-weight:bold;">+${edge.toFixed(1)}%</span>`;
    if(edge < -5) return `<span style="color:red; font-weight:bold;">${edge.toFixed(1)}%</span>`;
    return `<span style="color:orange;">${edge.toFixed(1)}%</span>`;
  };

  // Formatera xT-v√§rden med f√§rgkodning
  const formatxT = (xt) => {
    if(xt >= 0.8) return `<span style="color:#22c55e; font-weight:bold;">${xt.toFixed(3)}</span>`;
    if(xt >= 0.4) return `<span style="color:#f59e0b; font-weight:bold;">${xt.toFixed(3)}</span>`;
    if(xt >= 0.2) return `<span style="color:#6b7280;">${xt.toFixed(3)}</span>`;
    return `<span style="color:#ef4444;">${xt.toFixed(3)}</span>`;
  };

  document.getElementById("result").innerHTML = `
    <div style="background:#e8f5e8; border:1px solid #4caf50; border-radius:8px; padding:10px; margin:10px 0;">
      <span class="pill">F√∂rv. m√•l kvar H: ${lamH.toFixed(2)}</span>
      <span class="pill">F√∂rv. m√•l kvar B: ${lamA.toFixed(2)}</span>
      <span class="pill">Minuter kvar: ${R}</span>
      <span class="pill">MC-simuleringar: ${sims}</span>
    </div>
    
    ${recommendations.length > 0 ? `
    <div style="background:#fff3cd; border:1px solid #ffc107; border-radius:8px; padding:15px; margin:15px 0;">
      <h4 style="margin:0 0 10px 0; color:#856404;">üéØ Intelligenta rekommendationer (${currentTotalGoals} m√•l gjorda)</h4>
      ${recommendations.map(rec => `
        <div style="background:white; border-left:4px solid ${rec.type === 'STARK' ? '#28a745' : '#ffc107'}; padding:10px; margin:8px 0; border-radius:4px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="color:${rec.type === 'STARK' ? '#28a745' : '#856404'};">${rec.market}</strong>
            <span style="background:${rec.type === 'STARK' ? '#28a745' : '#ffc107'}; color:white; padding:2px 8px; border-radius:12px; font-size:12px; font-weight:bold;">
              ${rec.confidence}% ${rec.type}
            </span>
          </div>
          <div style="font-size:13px; color:#666; margin-top:5px;">${rec.reason}</div>
        </div>
      `).join('')}
      <div style="font-size:12px; color:#856404; margin-top:10px; font-style:italic;">
        üí° Rekommendationerna baseras p√• xT-analys, momentum och matchsituation
      </div>
    </div>
    ` : ''}
    
    <h4>xT & Momentum-baserad analys</h4>
    
    <div style="background:#f0f8ff; border:1px solid #b3d9ff; border-radius:8px; padding:12px; margin:10px 0; font-size:13px;">
      <strong>üìä xT-v√§rden f√∂rklarat:</strong><br>
      <span style="color:#22c55e;">‚Ä¢ 0.8+ = Mycket h√∂g fara</span> | 
      <span style="color:#f59e0b;">‚Ä¢ 0.4-0.8 = H√∂g fara</span> | 
      <span style="color:#6b7280;">‚Ä¢ 0.2-0.4 = M√•ttlig fara</span> | 
      <span style="color:#ef4444;">‚Ä¢ Under 0.2 = L√•g fara</span><br>
      <em>xT m√§ter lagets totala m√•lhot baserat p√• skott, tr√§ffs√§kerhet och positioner</em>
    </div>
    
    <table>
      <thead>
        <tr><th>Lag</th><th>xT-v√§rde</th><th>Momentum</th><th>M√•lfrekvens/min</th><th>F√∂rv. m√•l kvar</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>Hemmalag</strong></td><td>${formatxT(rates.xTHome)}</td><td>${rates.momentumHome.toFixed(3)}</td><td>${rates.homeRate.toFixed(4)}</td><td>${lamH.toFixed(2)}</td></tr>
        <tr><td><strong>Bortalag</strong></td><td>${formatxT(rates.xTAway)}</td><td>${rates.momentumAway.toFixed(3)}</td><td>${rates.awayRate.toFixed(4)}</td><td>${lamA.toFixed(2)}</td></tr>
      </tbody>
    </table>
    
    <h4>Marknadsanalys (Poisson vs Monte Carlo)</h4>
    <table>
      <thead>
        <tr><th>Marknad</th><th>Poisson odds</th><th>MC odds</th><th>Marknadsodds</th><th>V√§rde?</th></tr>
      </thead>
      <tbody>
        <tr><td>Inga m√•l</td><td>${f_noGoal}</td><td>${mc_f_noGoal}</td><td>-</td><td>-</td></tr>
        <tr><td>√ñver 0.5</td><td>${f_over05}</td><td>${mc_f_over05}</td><td>${mkt_over05}</td><td>${valueCheck(mkt_over05, f_over05)}</td></tr>
        <tr><td>√ñver 1.5</td><td>${f_over15}</td><td>${mc_f_over15}</td><td>${mkt_over15}</td><td>${valueCheck(mkt_over15, f_over15)}</td></tr>
        <tr><td>Hemma</td><td>${f_H}</td><td>${mc_f_H}</td><td>${mkt_home}</td><td>${valueCheck(mkt_home, f_H)}</td></tr>
        <tr><td>Oavgjort</td><td>${f_X}</td><td>${mc_f_X}</td><td>${mkt_draw}</td><td>${valueCheck(mkt_draw, f_X)}</td></tr>
        <tr><td>Borta</td><td>${f_A}</td><td>${mc_f_A}</td><td>${mkt_away}</td><td>${valueCheck(mkt_away, f_A)}</td></tr>
      </tbody>
    </table>
    
    <div style="margin-top:15px; font-size:13px; color:#666;">
      <strong>xT-modell:</strong> F√∂rv√§ntad fara baserat p√• skottstatistik, tr√§ffs√§kerhet och positioner<br>
      <strong>Momentum:</strong> Tidsbaserad viktning med m√•lhistorik och kortp√•verkan<br>
      <strong>MC vs Poisson:</strong> Monte Carlo simulering (${sims} k√∂rningar) vs teoretisk Poisson-f√∂rdelning
    </div>
  `;
}

// Sparfunktioner - globalt tillg√§ngliga
function saveCalculation() {
  const data = {
    timestamp: new Date().toLocaleString('sv-SE'),
    inputs: {
      minute: document.getElementById('minute').value,
      stopp: document.getElementById('stopp').value,
      sh: document.getElementById('sh').value,
      sa: document.getElementById('sa').value,
      yc: document.getElementById('yc').value,
      red_h: document.getElementById('red_h').value,
      red_a: document.getElementById('red_a').value,
      shots_h: document.getElementById('shots_h').value,
      shots_a: document.getElementById('shots_a').value,
      sot_h: document.getElementById('sot_h').value,
      sot_a: document.getElementById('sot_a').value,
      corners_h: document.getElementById('corners_h').value,
      corners_a: document.getElementById('corners_a').value,
      da_h: document.getElementById('da_h').value,
      da_a: document.getElementById('da_a').value,
      mkt_over05: document.getElementById('mkt_over05').value,
      mkt_over15: document.getElementById('mkt_over15').value,
      mkt_home: document.getElementById('mkt_home').value,
      mkt_draw: document.getElementById('mkt_draw').value,
      mkt_away: document.getElementById('mkt_away').value,
      sims: document.getElementById('sims').value
    }
  };

  const name = prompt('Namnge denna ber√§kning:');
  if (!name) return;

  data.name = name;

  let saved = JSON.parse(localStorage.getItem('xTCalculations') || '[]');
  saved.unshift(data);
  if (saved.length > 20) saved = saved.slice(0, 20);
  localStorage.setItem('xTCalculations', JSON.stringify(saved));
  alert('Ber√§kning sparad!');
}

function loadCalculation() {
  const saved = JSON.parse(localStorage.getItem('xTCalculations') || '[]');
  if (saved.length === 0) {
    alert('Inga sparade ber√§kningar finns.');
    return;
  }

  const names = saved.map((calc, i) => `${i + 1}. ${calc.name} (${calc.timestamp})`);
  const choice = prompt('V√§lj ber√§kning att ladda:\n\n' + names.join('\n') + '\n\nAnge nummer:');
  const index = parseInt(choice) - 1;

  if (index >= 0 && index < saved.length) {
    loadSavedCalculation(index);
  }
}

function showSavedList() {
  const saved = JSON.parse(localStorage.getItem('xTCalculations') || '[]');
  const listDiv = document.getElementById('savedList');
  const itemsDiv = document.getElementById('savedItems');

  if (saved.length === 0) {
    itemsDiv.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Inga sparade ber√§kningar</div>';
  } else {
    itemsDiv.innerHTML = saved.map((calc, index) => `
      <div class="saved-item" onclick="loadSavedCalculation(${index})">
        <div class="saved-item-header">${calc.name}</div>
        <div class="saved-item-details">
          ${calc.timestamp} | M√•l: ${calc.inputs.sh}-${calc.inputs.sa} | 
          Min: ${calc.inputs.minute} | 
          <span onclick="deleteSavedCalculation(${index}); event.stopPropagation();" style="color:#ef4444; cursor:pointer;">üóëÔ∏è Ta bort</span>
        </div>
      </div>
    `).join('');
  }

  listDiv.style.display = listDiv.style.display === 'none' ? 'block' : 'none';
}

function loadSavedCalculation(index) {
  const saved = JSON.parse(localStorage.getItem('xTCalculations') || '[]');
  if (index >= 0 && index < saved.length) {
    const calc = saved[index];
    Object.keys(calc.inputs).forEach(key => {
      const element = document.getElementById(key);
      if (element) element.value = calc.inputs[key];
    });
    document.getElementById('savedList').style.display = 'none';
    alert(`Ber√§kning "${calc.name}" laddad!`);
  }
}

function deleteSavedCalculation(index) {
  if (confirm('√Ñr du s√§ker p√• att du vill ta bort denna ber√§kning?')) {
    let saved = JSON.parse(localStorage.getItem('xTCalculations') || '[]');
    saved.splice(index, 1);
    localStorage.setItem('xTCalculations', JSON.stringify(saved));
    showSavedList();
  }
}

// Testfunktion f√∂r xT-validering med evidensbaserade scenarier
function testxTValidation() {
  console.log("=== xT VALIDERING MED EVIDENSBASERADE SCENARIER ===");
  
  // Scenario 1: L√•g aktivitet (defensiv match)
  const lowActivity = calculatexT(3, 1, 2, 35, 0, 45);
  console.log(`L√•g aktivitet (3 skott, 1 p√• m√•l, 2 h√∂rn, 35% boll): xT = ${lowActivity.toFixed(3)}`);
  
  // Scenario 2: M√•ttlig aktivitet (normal match)
  const mediumActivity = calculatexT(8, 4, 5, 55, 1, 60);
  console.log(`M√•ttlig aktivitet (8 skott, 4 p√• m√•l, 5 h√∂rn, 55% boll): xT = ${mediumActivity.toFixed(3)}`);
  
  // Scenario 3: H√∂g aktivitet (offensiv match)
  const highActivity = calculatexT(15, 8, 8, 65, 2, 75);
  console.log(`H√∂g aktivitet (15 skott, 8 p√• m√•l, 8 h√∂rn, 65% boll): xT = ${highActivity.toFixed(3)}`);
  
  // Scenario 4: Extremt h√∂g aktivitet (m√•lrik match)
  const extremeActivity = calculatexT(22, 12, 12, 70, 3, 80);
  console.log(`Extrem aktivitet (22 skott, 12 p√• m√•l, 12 h√∂rn, 70% boll): xT = ${extremeActivity.toFixed(3)}`);
  
  // Validering av logiska f√∂rh√•llanden
  console.log("\n=== LOGISK VALIDERING ===");
  console.log(`L√•g < M√•ttlig: ${lowActivity < mediumActivity ? '‚úÖ' : '‚ùå'}`);
  console.log(`M√•ttlig < H√∂g: ${mediumActivity < highActivity ? '‚úÖ' : '‚ùå'}`);
  console.log(`H√∂g < Extrem: ${highActivity < extremeActivity ? '‚úÖ' : '‚ùå'}`);
  
  // Test av tr√§ffs√§kerhetens p√•verkan
  const lowAccuracy = calculatexT(10, 2, 5, 50, 0, 60); // 20% tr√§ffs√§kerhet
  const highAccuracy = calculatexT(10, 8, 5, 50, 2, 60); // 80% tr√§ffs√§kerhet
  console.log(`\nTr√§ffs√§kerhet 20%: xT = ${lowAccuracy.toFixed(3)}`);
  console.log(`Tr√§ffs√§kerhet 80%: xT = ${highAccuracy.toFixed(3)}`);
  console.log(`H√∂g tr√§ffs√§kerhet > L√•g: ${highAccuracy > lowAccuracy ? '‚úÖ' : '‚ùå'}`);
  
  // Test av m√•leffektivitetens p√•verkan
  const noGoals = calculatexT(10, 5, 5, 50, 0, 60);
  const withGoals = calculatexT(10, 5, 5, 50, 2, 60);
  console.log(`\nUtan m√•l: xT = ${noGoals.toFixed(3)}`);
  console.log(`Med 2 m√•l: xT = ${withGoals.toFixed(3)}`);
  console.log(`Med m√•l > Utan m√•l: ${withGoals > noGoals ? '‚úÖ' : '‚ùå'}`);
  
  // Evidensbaserad validering mot verkliga v√§rden
  console.log("\n=== EVIDENSBASERAD VALIDERING ===");
  console.log("F√∂rv√§ntade xT-intervall baserat p√• fotbollsstatistik:");
  console.log(`L√•g aktivitet (0.1-0.3): ${lowActivity >= 0.1 && lowActivity <= 0.3 ? '‚úÖ' : '‚ùå'}`);
  console.log(`M√•ttlig aktivitet (0.3-0.6): ${mediumActivity >= 0.3 && mediumActivity <= 0.6 ? '‚úÖ' : '‚ùå'}`);
  console.log(`H√∂g aktivitet (0.6-1.0): ${highActivity >= 0.6 && highActivity <= 1.0 ? '‚úÖ' : '‚ùå'}`);
  console.log(`Extrem aktivitet (1.0+): ${extremeActivity >= 1.0 ? '‚úÖ' : '‚ùå'}`);
  
  return {
    lowActivity,
    mediumActivity,
    highActivity,
    extremeActivity,
    logicalOrder: lowActivity < mediumActivity && mediumActivity < highActivity && highActivity < extremeActivity,
    accuracyImpact: highAccuracy > lowAccuracy,
    goalImpact: withGoals > noGoals
  };
}

// L√§gg till testknapp i HTML
function addTestButton() {
  const testButton = document.createElement('button');
  testButton.textContent = 'Testa xT-validering';
  testButton.style.cssText = 'background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; margin:10px; cursor:pointer;';
  testButton.onclick = () => {
    const results = testxTValidation();
    alert(`xT-test slutf√∂rt! Kolla konsolen f√∂r detaljer.\n\nSammanfattning:\n‚úÖ Logisk ordning: ${results.logicalOrder}\n‚úÖ Tr√§ffs√§kerhetsp√•verkan: ${results.accuracyImpact}\n‚úÖ M√•lp√•verkan: ${results.goalImpact}`);
  };
  document.body.appendChild(testButton);
}

 // K√∂r test automatiskt n√§r sidan laddas
 document.addEventListener('DOMContentLoaded', () => {
   addTestButton();
   console.log("xT-testfunktion tillg√§nglig. Klicka p√• 'Testa xT-validering' eller k√∂r testxTValidation() i konsolen.");
 });

</script>
</body>
</html>
