<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bet365 Live xT & Momentum-kalkylator ‚Äì Expected Threat + Monte Carlo</title>
  <style>
    :root {
      --blue:#004aad;
      --green:#22c55e;
      --amber:#f59e0b;
      --bg:#f9f9f9;
      --card:#ffffff;
      --muted:#eef6ff;
      --border:#e5e7eb;
      --ink:#1a1a1a;
    }
    body {font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:0;}
    header {background:var(--blue); color:#fff; padding:20px; text-align:center;}
    .nav {margin-top:15px;}
    .nav a {background:#fff; color:var(--blue); text-decoration:none; padding:6px 12px; border-radius:6px; font-weight:600; font-size:14px; margin:0 5px;}
    .nav a:hover {background:#f0f8ff;}
    .container {padding:20px;}
    h1 {color:#fff; margin-top:0;}
    .grid2 {display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card {background:var(--card); border:1px solid var(--border); border-radius:8px; padding:20px; margin:10px 0;}
    .input-group {margin:10px 0;}
    label {display:block; margin-bottom:5px; font-weight:bold;}
    input, select {width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; box-sizing:border-box;}
    button {background:var(--blue); color:white; padding:12px 24px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin:10px 5px 10px 0;}
    button:hover {opacity:0.9;}
    table {width:100%; border-collapse:collapse; margin:15px 0;}
    th, td {border:1px solid var(--border); padding:8px; text-align:left;}
    th {background:var(--muted); font-weight:bold;}
    .highlight {background:var(--muted);}
    #out {display:none; margin-top:20px;}
    .value-bet {color:var(--green); font-weight:bold;}
    .no-value {color:#666;}
  </style>
</head>
<body>
  <header>
    <h1>üéØ Bet365 Live xT & Momentum-kalkylator</h1>
    <div class="nav">
      <a href="index.html">üè† Hem</a>
      <a href="prematch.html">‚¨ÖÔ∏è Pre-Match</a>
      <a href="live.html">üìä Live</a>
      <a href="livecalc.html">‚öΩ xG Kalkylator</a>
    </div>
  </header>
  <div class="container">
    <p><strong>Expected Threat (xT)</strong> + <strong>Momentum</strong> + <strong>Monte Carlo-simulering</strong> f√∂r live-betting</p>

  <div class="grid2">
    <div class="card">
      <h3>‚öΩ Hemmalag</h3>
      <div class="input-group">
        <label>Skott hittills:</label>
        <input type="number" id="homeShots" value="8" min="0">
      </div>
      <div class="input-group">
        <label>Skott p√• m√•l:</label>
        <input type="number" id="homeShotsOnTarget" value="3" min="0">
      </div>
      <div class="input-group">
        <label>M√•l gjorda:</label>
        <input type="number" id="homeGoals" value="1" min="0">
      </div>
      <div class="input-group">
        <label>H√∂rnsparkar:</label>
        <input type="number" id="homeCorners" value="4" min="0">
      </div>
      <div class="input-group">
        <label>Bollinnehav (%):</label>
        <input type="number" id="homePossession" value="58" min="0" max="100">
      </div>
      <div class="input-group">
        <label>Gula kort:</label>
        <input type="number" id="homeYellowCards" value="1" min="0">
      </div>
      <div class="input-group">
        <label>R√∂da kort:</label>
        <input type="number" id="homeRedCards" value="0" min="0">
      </div>
    </div>

    <div class="card">
      <h3>üèÉ Bortalag</h3>
      <div class="input-group">
        <label>Skott hittills:</label>
        <input type="number" id="awayShots" value="5" min="0">
      </div>
      <div class="input-group">
        <label>Skott p√• m√•l:</label>
        <input type="number" id="awayShotsOnTarget" value="2" min="0">
      </div>
      <div class="input-group">
        <label>M√•l gjorda:</label>
        <input type="number" id="awayGoals" value="0" min="0">
      </div>
      <div class="input-group">
        <label>H√∂rnsparkar:</label>
        <input type="number" id="awayCorners" value="2" min="0">
      </div>
      <div class="input-group">
        <label>Bollinnehav (%):</label>
        <input type="number" id="awayPossession" value="42" min="0" max="100">
      </div>
      <div class="input-group">
        <label>Gula kort:</label>
        <input type="number" id="awayYellowCards" value="2" min="0">
      </div>
      <div class="input-group">
        <label>R√∂da kort:</label>
        <input type="number" id="awayRedCards" value="0" min="0">
      </div>
    </div>
  </div>

  <div class="card">
    <h3>‚è±Ô∏è Matchinformation</h3>
    <div class="grid2">
      <div class="input-group">
        <label>Spelad tid (minuter):</label>
        <input type="number" id="minutesPlayed" value="35" min="0" max="120">
      </div>
      <div class="input-group">
        <label>Total matchtid (minuter):</label>
        <input type="number" id="totalMinutes" value="90" min="45" max="120">
      </div>
    </div>
  </div>

  <div class="card">
    <h3>üìä Marknadsodds (f√∂r v√§rdeanalys)</h3>
    <div class="grid2">
      <div>
        <div class="input-group">
          <label>√ñver 0.5 m√•l:</label>
          <input type="number" id="over05Odds" value="1.15" step="0.01" min="1.01">
        </div>
        <div class="input-group">
          <label>√ñver 1.5 m√•l:</label>
          <input type="number" id="over15Odds" value="1.85" step="0.01" min="1.01">
        </div>
        <div class="input-group">
          <label>Monte Carlo-simuleringar:</label>
          <input type="number" id="simulations" value="10000" min="1000" max="100000" step="1000">
        </div>
      </div>
      <div>
        <div class="input-group">
          <label>Hemmavinst:</label>
          <input type="number" id="homeWinOdds" value="2.10" step="0.01" min="1.01">
        </div>
        <div class="input-group">
          <label>Oavgjort:</label>
          <input type="number" id="drawOdds" value="3.40" step="0.01" min="1.01">
        </div>
        <div class="input-group">
          <label>Bortavinst:</label>
          <input type="number" id="awayWinOdds" value="3.75" step="0.01" min="1.01">
        </div>
      </div>
    </div>
  </div>

  <button onclick="runCalc()">üî• Ber√§kna xT & Momentum</button>
  <button onclick="saveCalculation()" id="saveBtn" style="background:#22c55e; display:none;">üíæ Spara ber√§kning</button>
  <button onclick="showSavedCalculations()" style="background:#f59e0b;">üìã Visa sparade</button>

  <div id="out"></div>
  <div id="savedCalculations" style="display:none;"></div>

<script>
// xT-ber√§kning (Expected Threat) - realistiska koefficienter f√∂r fotbollsscenarier
function calculatexT(shots, shotsOnTarget, goals, corners, possession) {
  const shotThreat = shots * 0.01; // Ytterligare reducerat f√∂r realism
  const accuracyBonus = (shotsOnTarget / Math.max(shots, 1)) * 0.04; // Halverat f√∂r b√§ttre balans
  const conversionBonus = (goals / Math.max(shotsOnTarget, 1)) * 0.08; // Reducerat f√∂r realistiska niv√•er
  const cornerThreat = corners * 0.015; // Halverat - h√∂rn mindre viktiga
  const possessionThreat = (possession / 100) * 0.025; // Halverat f√∂r subtilare p√•verkan
  
  return shotThreat + accuracyBonus + conversionBonus + cornerThreat + possessionThreat;
}

// Momentum-ber√§kning med tidsbaserad viktning
function calculateMomentum(goals, shots, corners, minutesPlayed, totalMinutes) {
  // Tidsbaserad viktning - √∂kar med tiden (tidspress)
  const timeWeight = Math.min(minutesPlayed / 30, 1);
  const timePressure = (minutesPlayed / totalMinutes) * 0.5; // √ñkad viktning f√∂r tidspress
  
  // Offensiv momentum baserat p√• statistik
  const goalMomentum = goals * 0.4; // M√•l har h√∂gst viktning
  const shotMomentum = shots * 0.1; // Skott indikerar tryck
  const cornerMomentum = corners * 0.15; // H√∂rn indikerar dominans
  
  // Kombinera alla faktorer
  const baseMomentum = goalMomentum + shotMomentum + cornerMomentum + timePressure;
  
  return Math.max(0, baseMomentum * timeWeight);
}

// Poisson-sannolikhet
function poissonProb(k, lambda) {
  return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k);
}

function factorial(n) {
  if (n <= 1) return 1;
  return n * factorial(n - 1);
}

// Monte Carlo-simulering
function runMonteCarlo(homeRate, awayRate, sims) {
  let results = { home: 0, draw: 0, away: 0, over05: 0, over15: 0, noGoals: 0 };
  
  for (let i = 0; i < sims; i++) {
    const homeGoals = poissonRandom(homeRate);
    const awayGoals = poissonRandom(awayRate);
    const totalGoals = homeGoals + awayGoals;
    
    if (homeGoals > awayGoals) results.home++;
    else if (homeGoals < awayGoals) results.away++;
    else results.draw++;
    
    if (totalGoals > 0.5) results.over05++;
    if (totalGoals > 1.5) results.over15++;
    if (totalGoals === 0) results.noGoals++;
  }
  
  return {
    home: results.home / sims,
    draw: results.draw / sims,
    away: results.away / sims,
    over05: results.over05 / sims,
    over15: results.over15 / sims,
    noGoals: results.noGoals / sims
  };
}

function poissonRandom(lambda) {
  const L = Math.exp(-lambda);
  let k = 0;
  let p = 1;
  
  do {
    k++;
    p *= Math.random();
  } while (p > L);
  
  return k - 1;
}

// Formatering av xT-v√§rden (justerade tr√∂skelv√§rden)
function formatxT(value) {
  const color = value >= 0.30 ? '#22c55e' : value >= 0.20 ? '#f59e0b' : value >= 0.10 ? '#6b7280' : '#ef4444';
  return `<span style="color:${color}; font-weight:bold;">${value.toFixed(3)}</span>`;
}

// V√§rdeanalys
function valueCheck(marketOdds, fairOdds) {
  if (marketOdds === '-' || fairOdds === '-') return '-';
  const fairProb = 1 / fairOdds;
  const marketProb = 1 / marketOdds;
  const edge = fairProb - marketProb;
  
  if (edge > 0.05) return `<span class="value-bet">‚úÖ V√ÑRDE (${(edge * 100).toFixed(1)}%)</span>`;
  return `<span class="no-value">‚ùå Inget v√§rde</span>`;
}

// Intelligent rekommendationsfunktion
function generateRecommendations(inputs, results) {
  const totalGoals = inputs.homeGoals + inputs.awayGoals;
  const totalShots = inputs.homeShots + inputs.awayShots;
  const avgMomentum = (results.rates.momentumHome + results.rates.momentumAway) / 2;
  const maxXt = Math.max(results.rates.xTHome, results.rates.xTAway);
  const minXt = Math.min(results.rates.xTHome, results.rates.xTAway);
  const remainingTime = inputs.totalMinutes - inputs.minutesPlayed;
  const expectedGoalsRemaining = results.rates.homeRate + results.rates.awayRate;
  const shotsPerGoal = totalGoals > 0 ? totalShots / totalGoals : totalShots;
  const gamePhase = inputs.minutesPlayed <= 30 ? 'early' : inputs.minutesPlayed <= 60 ? 'middle' : 'late';
  
  let recommendations = [];
  let priority = 'medium';
  
  // Scenario 1: M√•nga m√•l redan (3+)
  if (totalGoals >= 3) {
    priority = 'high';
    recommendations.push({
      type: '√ñver/Under m√•l',
      suggestion: totalGoals >= 4 ? `√ñver 4.5/5.5 m√•l` : `√ñver 3.5/4.5 m√•l`,
      reason: `${totalGoals} m√•l redan gjorda. H√∂g m√•lfrekvens forts√§tter troligen.`,
      confidence: 'H√∂g',
      icon: 'üéØ'
    });
    
    if (avgMomentum > 2.0) {
      recommendations.push({
        type: 'Live-betting',
        suggestion: 'N√§sta m√•l inom 15 min',
        reason: `Extremt h√∂gt momentum (${avgMomentum.toFixed(2)}). Offensiv press forts√§tter.`,
        confidence: 'Mycket h√∂g',
        icon: '‚ö°'
      });
    }
    
    // Extra scenario f√∂r mycket h√∂ga m√•lantal
    if (totalGoals >= 5) {
      recommendations.push({
        type: 'Rekordmatch',
        suggestion: '√ñver 6.5 m√•l - Historisk chans',
        reason: `${totalGoals} m√•l! Detta √§r en exceptionell m√•lrik match.`,
        confidence: 'Mycket h√∂g',
        icon: 'üöÄ'
      });
    }
  }
  
  // Scenario 2: H√∂g aktivitet men f√• m√•l (underperformance)
  else if (totalShots >= 15 && totalGoals <= 1) {
    priority = 'high';
    recommendations.push({
      type: '√ñver/Under m√•l',
      suggestion: '√ñver 1.5/2.5 m√•l',
      reason: `${totalShots} skott men bara ${totalGoals} m√•l. Statistisk regression v√§ntas.`,
      confidence: 'H√∂g',
      icon: 'üìà'
    });
    
    if (shotsPerGoal > 20) {
      recommendations.push({
        type: 'Effektivitet',
        suggestion: 'N√§sta skott blir m√•l',
        reason: `Extremt l√•g tr√§ffs√§kerhet (${shotsPerGoal.toFixed(1)} skott/m√•l). Lag kommer hitta n√§tet snart.`,
        confidence: 'H√∂g',
        icon: 'üéØ'
      });
    }
  }
  
  // Scenario 3: Extremt h√∂gt xT-v√§rde (justerat tr√∂skelv√§rde)
  if (maxXt >= 0.30) {
    const dominantTeam = results.rates.xTHome > results.rates.xTAway ? 'Hemmalaget' : 'Bortalaget';
    recommendations.push({
      type: 'M√•lskytt',
      suggestion: `N√§sta m√•lskytt fr√•n ${dominantTeam.toLowerCase()}`,
      reason: `Extremt h√∂gt xT-v√§rde (${maxXt.toFixed(3)}). Mycket h√∂g farlighet.`,
      confidence: 'H√∂g',
      icon: 'üî•'
    });
  }
  
  // Scenario 4: Sent i matchen med h√∂gt momentum
  if (remainingTime <= 20 && avgMomentum > 1.5) {
    recommendations.push({
      type: 'Slutspurt',
      suggestion: remainingTime <= 10 ? 'M√•l i till√§ggstid' : 'M√•l i slutminuterna',
      reason: `H√∂gt momentum (${avgMomentum.toFixed(2)}) med ${remainingTime} min kvar. Desperat slutspurt.`,
      confidence: remainingTime <= 10 ? 'H√∂g' : 'Medium',
      icon: '‚è∞'
    });
  }
  
  // Scenario 5: F√∂rv√§ntade m√•l kvar
  if (expectedGoalsRemaining >= 1.5) {
    recommendations.push({
      type: '√ñver/Under m√•l',
      suggestion: `√ñver ${Math.floor(totalGoals + 1.5)}.5 m√•l`,
      reason: `${expectedGoalsRemaining.toFixed(1)} f√∂rv√§ntade m√•l kvar baserat p√• nuvarande tempo.`,
      confidence: 'Medium',
      icon: 'üìä'
    });
  }
  
  // Scenario 6: Asymmetrisk match (en sida dominerar) - justerade tr√∂skelv√§rden
  const xTDiff = Math.abs(results.rates.xTHome - results.rates.xTAway);
  if (xTDiff > 0.15) {
    const dominantTeam = results.rates.xTHome > results.rates.xTAway ? 'Hemmalaget' : 'Bortalaget';
    recommendations.push({
      type: 'Resultat',
      suggestion: `${dominantTeam} att vinna`,
      reason: `Stor xT-skillnad (${xTDiff.toFixed(3)}). ${dominantTeam} dominerar helt.`,
      confidence: xTDiff > 0.25 ? 'H√∂g' : 'Medium',
      icon: 'üëë'
    });
    
    // Extra rekommendation f√∂r extremt dominans
    if (xTDiff > 0.25) {
      recommendations.push({
        type: 'Handicap',
        suggestion: `${dominantTeam} -1.5 handicap`,
        reason: `Extrem dominans (${xTDiff.toFixed(3)} xT-skillnad). Stor seger trolig.`,
        confidence: 'Medium',
        icon: 'üí™'
      });
    }
  }
  
  // Scenario 7: Tidig fas med h√∂g aktivitet
  if (gamePhase === 'early' && totalShots >= 8) {
    recommendations.push({
      type: 'Tempo',
      suggestion: '√ñver 2.5/3.5 m√•l',
      reason: `${totalShots} skott redan efter ${inputs.minutesPlayed} min. H√∂gt tempo hela matchen.`,
      confidence: 'Medium',
      icon: 'üèÉ'
    });
  }
  
  // Scenario 8: L√•g aktivitet sent i matchen
  if (gamePhase === 'late' && totalShots < 8 && totalGoals === 0) {
    recommendations.push({
      type: 'Defensiv match',
      suggestion: 'Under 1.5 m√•l',
      reason: `Bara ${totalShots} skott efter ${inputs.minutesPlayed} min. Mycket defensiv match.`,
      confidence: 'Medium',
      icon: 'üõ°Ô∏è'
    });
  }
  
  // Scenario 9: Balanserad match med j√§mna xT-v√§rden
  if (xTDiff < 0.1 && Math.abs(results.rates.momentumHome - results.rates.momentumAway) < 0.5) {
    recommendations.push({
      type: 'J√§mn match',
      suggestion: 'Oavgjort eller X2',
      reason: `Mycket j√§mn match (xT-skillnad: ${xTDiff.toFixed(3)}). Sv√•r att f√∂ruts√§ga vinnare.`,
      confidence: 'Medium',
      icon: '‚öñÔ∏è'
    });
  }
  
  // Scenario 10: Momentum-v√§xling
  const momentumDiff = Math.abs(results.rates.momentumHome - results.rates.momentumAway);
  if (momentumDiff > 1.0) {
    const momentumTeam = results.rates.momentumHome > results.rates.momentumAway ? 'Hemmalaget' : 'Bortalaget';
    recommendations.push({
      type: 'Momentum',
      suggestion: `${momentumTeam} n√§sta m√•l`,
      reason: `Stark momentum-skillnad (${momentumDiff.toFixed(2)}). ${momentumTeam} pressar h√•rt.`,
      confidence: 'Medium',
      icon: 'üåä'
    });
  }
  
  // Om inga specifika rekommendationer, ge allm√§nna r√•d
  if (recommendations.length === 0) {
    recommendations.push({
      type: 'Allm√§nt',
      suggestion: 'Avvakta utveckling',
      reason: 'Balanserad match utan tydliga m√∂nster. V√§nta p√• mer data.',
      confidence: 'L√•g',
      icon: '‚è≥'
    });
  }
  
  // Begr√§nsa till max 4 rekommendationer f√∂r att undvika √∂verbelastning
  if (recommendations.length > 4) {
    recommendations = recommendations.slice(0, 4);
  }
  
  return { recommendations, priority };
}

// Huvudber√§kningsfunktion
function runCalc() {
  // H√§mta v√§rden
  const homeShots = parseInt(document.getElementById("homeShots").value) || 0;
  const homeShotsOnTarget = parseInt(document.getElementById("homeShotsOnTarget").value) || 0;
  const homeGoals = parseInt(document.getElementById("homeGoals").value) || 0;
  const homeCorners = parseInt(document.getElementById("homeCorners").value) || 0;
  const homePossession = parseInt(document.getElementById("homePossession").value) || 0;
  const homeYellowCards = parseInt(document.getElementById("homeYellowCards").value) || 0;
  const homeRedCards = parseInt(document.getElementById("homeRedCards").value) || 0;

  const awayShots = parseInt(document.getElementById("awayShots").value) || 0;
  const awayShotsOnTarget = parseInt(document.getElementById("awayShotsOnTarget").value) || 0;
  const awayGoals = parseInt(document.getElementById("awayGoals").value) || 0;
  const awayCorners = parseInt(document.getElementById("awayCorners").value) || 0;
  const awayPossession = parseInt(document.getElementById("awayPossession").value) || 0;
  const awayYellowCards = parseInt(document.getElementById("awayYellowCards").value) || 0;
  const awayRedCards = parseInt(document.getElementById("awayRedCards").value) || 0;

  const minutesPlayed = parseInt(document.getElementById("minutesPlayed").value) || 0;
  const totalMinutes = parseInt(document.getElementById("totalMinutes").value) || 90;
  const sims = parseInt(document.getElementById("simulations").value) || 10000;

  const mkt_over05 = parseFloat(document.getElementById("over05Odds").value) || 0;
  const mkt_over15 = parseFloat(document.getElementById("over15Odds").value) || 0;
  const mkt_home = parseFloat(document.getElementById("homeWinOdds").value) || 0;
  const mkt_draw = parseFloat(document.getElementById("drawOdds").value) || 0;
  const mkt_away = parseFloat(document.getElementById("awayWinOdds").value) || 0;

  // Ber√§kna xT och momentum
  const rates = {
    xTHome: calculatexT(homeShots, homeShotsOnTarget, homeGoals, homeCorners, homePossession),
    xTAway: calculatexT(awayShots, awayShotsOnTarget, awayGoals, awayCorners, awayPossession),
    momentumHome: calculateMomentum(homeGoals, homeShots, homeCorners, minutesPlayed, totalMinutes),
    momentumAway: calculateMomentum(awayGoals, awayShots, awayCorners, minutesPlayed, totalMinutes)
  };

  // Ber√§kna m√•lfrekvenser
  const remainingMinutes = totalMinutes - minutesPlayed;
  const xTAdjustedHome = rates.xTHome * (1 + rates.momentumHome);
  const xTAdjustedAway = rates.xTAway * (1 + rates.momentumAway);
  
  rates.homeRate = (xTAdjustedHome * remainingMinutes) / 90;
  rates.awayRate = (xTAdjustedAway * remainingMinutes) / 90;

  // Poisson-ber√§kningar
  const lamH = rates.homeRate;
  const lamA = rates.awayRate;

  // Ber√§kna sannolikheter
  let f_H = 0, f_X = 0, f_A = 0;
  for (let h = 0; h <= 10; h++) {
    for (let a = 0; a <= 10; a++) {
      const prob = poissonProb(h, lamH) * poissonProb(a, lamA);
      if (h > a) f_H += prob;
      else if (h === a) f_X += prob;
      else f_A += prob;
    }
  }

  const f_over05 = 1 - poissonProb(0, lamH + lamA);
  const f_over15 = 1 - poissonProb(0, lamH + lamA) - poissonProb(1, lamH + lamA);
  const f_noGoal = poissonProb(0, lamH + lamA);

  // Monte Carlo-simulering
  const mcResults = runMonteCarlo(lamH, lamA, sims);

  // Konvertera till odds
  const toOdds = (prob) => prob > 0 ? (1 / prob).toFixed(2) : '-';
  
  document.getElementById("out").innerHTML = `
    <h3>üéØ xT & Momentum-analys</h3>
    
    <div style="background:#f0f8ff; border:1px solid #b3d9ff; border-radius:8px; padding:12px; margin:10px 0; font-size:13px;">
      <strong>üìä xT-v√§rden f√∂rklarat (justerade niv√•er):</strong><br>
      <span style="color:#22c55e;">‚Ä¢ 0.30+ = Mycket h√∂g fara</span> | 
      <span style="color:#f59e0b;">‚Ä¢ 0.20-0.30 = H√∂g fara</span> | 
      <span style="color:#6b7280;">‚Ä¢ 0.10-0.20 = M√•ttlig fara</span> | 
      <span style="color:#ef4444;">‚Ä¢ Under 0.10 = L√•g fara</span><br>
      <em>xT m√§ter lagets totala m√•lhot baserat p√• skott, tr√§ffs√§kerhet och positioner</em>
    </div>
    
    <table>
      <thead>
        <tr><th>Lag</th><th>xT-v√§rde</th><th>Momentum</th><th>M√•lfrekvens/min</th><th>F√∂rv. m√•l kvar</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>Hemmalag</strong></td><td>${formatxT(rates.xTHome)}</td><td>${rates.momentumHome.toFixed(3)}</td><td>${rates.homeRate.toFixed(4)}</td><td>${lamH.toFixed(2)}</td></tr>
        <tr><td><strong>Bortalag</strong></td><td>${formatxT(rates.xTAway)}</td><td>${rates.momentumAway.toFixed(3)}</td><td>${rates.awayRate.toFixed(4)}</td><td>${lamA.toFixed(2)}</td></tr>
      </tbody>
    </table>
    
    <h4>üìä Marknadsanalys (Poisson vs Monte Carlo)</h4>
    <table>
      <thead>
        <tr><th>Marknad</th><th>Poisson odds</th><th>MC odds</th><th>Marknadsodds</th><th>V√§rde?</th></tr>
      </thead>
      <tbody>
        <tr><td>Inga m√•l</td><td>${toOdds(f_noGoal)}</td><td>${toOdds(mcResults.noGoals)}</td><td>-</td><td>-</td></tr>
        <tr><td>√ñver 0.5</td><td>${toOdds(f_over05)}</td><td>${toOdds(mcResults.over05)}</td><td>${mkt_over05}</td><td>${valueCheck(mkt_over05, toOdds(f_over05))}</td></tr>
        <tr><td>√ñver 1.5</td><td>${toOdds(f_over15)}</td><td>${toOdds(mcResults.over15)}</td><td>${mkt_over15}</td><td>${valueCheck(mkt_over15, toOdds(f_over15))}</td></tr>
        <tr><td>Hemma</td><td>${toOdds(f_H)}</td><td>${toOdds(mcResults.home)}</td><td>${mkt_home}</td><td>${valueCheck(mkt_home, toOdds(f_H))}</td></tr>
        <tr><td>Oavgjort</td><td>${toOdds(f_X)}</td><td>${toOdds(mcResults.draw)}</td><td>${mkt_draw}</td><td>${valueCheck(mkt_draw, toOdds(f_X))}</td></tr>
        <tr><td>Borta</td><td>${toOdds(f_A)}</td><td>${toOdds(mcResults.away)}</td><td>${mkt_away}</td><td>${valueCheck(mkt_away, toOdds(f_A))}</td></tr>
      </tbody>
    </table>
    
    <div style="margin-top:15px; font-size:13px; color:#666;">
      <strong>xT-modell:</strong> F√∂rv√§ntad fara baserat p√• skottstatistik, tr√§ffs√§kerhet och positioner<br>
      <strong>Momentum:</strong> Tidsbaserad viktning med m√•lhistorik och kortp√•verkan<br>
      <strong>MC vs Poisson:</strong> Monte Carlo simulering (${sims} k√∂rningar) vs teoretisk Poisson-f√∂rdelning
    </div>
  `;
  
  // Generera och visa rekommendationer
  const recData = generateRecommendations({
    homeGoals: parseInt(homeGoals),
    awayGoals: parseInt(awayGoals),
    homeShots: parseInt(homeShots),
    awayShots: parseInt(awayShots),
    totalMinutes: parseInt(totalMinutes),
    minutesPlayed: parseInt(minutesPlayed)
  }, { rates });
  
  if (recData.recommendations.length > 0) {
    const recommendationsHTML = `
    <div style="margin-top:20px; padding:15px; background:${recData.priority === 'high' ? '#fff3cd' : '#d1ecf1'}; border-radius:8px; border-left:4px solid ${recData.priority === 'high' ? '#ffc107' : '#17a2b8'};">
      <h4 style="margin:0 0 15px 0; color:#333;">üéØ Intelligenta Rekommendationer</h4>
      ${recData.recommendations.map(rec => `
        <div style="margin-bottom:12px; padding:10px; background:white; border-radius:6px; border-left:3px solid ${rec.confidence === 'Mycket h√∂g' ? '#28a745' : rec.confidence === 'H√∂g' ? '#ffc107' : '#6c757d'};">
          <div style="display:flex; align-items:center; margin-bottom:5px;">
            <span style="font-size:18px; margin-right:8px;">${rec.icon}</span>
            <strong style="color:#333;">${rec.type}: ${rec.suggestion}</strong>
            <span style="margin-left:auto; font-size:12px; padding:2px 8px; background:${rec.confidence === 'Mycket h√∂g' ? '#28a745' : rec.confidence === 'H√∂g' ? '#ffc107' : '#6c757d'}; color:white; border-radius:12px;">${rec.confidence}</span>
          </div>
          <div style="font-size:13px; color:#666; line-height:1.4;">${rec.reason}</div>
        </div>
      `).join('')}
      <div style="margin-top:10px; font-size:12px; color:#666; font-style:italic;">
        ‚ö†Ô∏è Rekommendationer baseras p√• statistisk analys. Spela ansvarsfullt.
      </div>
    </div>
    `;
    
    // L√§gg till rekommendationerna till befintlig HTML
    document.getElementById("out").innerHTML += recommendationsHTML;
  }
  
  document.getElementById("out").style.display = "block";
  document.getElementById("saveBtn").style.display = "inline-block";
  
  // Spara aktuella data f√∂r sparfunktionen
  window.currentCalculation = {
    timestamp: new Date().toISOString(),
    inputs: {
      homeShots, homeShotsOnTarget, homeGoals, homeCorners, homePossession, homeYellowCards, homeRedCards,
      awayShots, awayShotsOnTarget, awayGoals, awayCorners, awayPossession, awayYellowCards, awayRedCards,
      minutesPlayed, totalMinutes, sims, mkt_over05, mkt_over15, mkt_home, mkt_draw, mkt_away
    },
    results: {
      rates: rates,
      poissonResults: { f_H, f_X, f_A, f_over05, f_over15, f_noGoal },
      monteCarloResults: mcResults,
      remainingMinutes: remainingMinutes
    }
  };
}

// Sparfunktion f√∂r ber√§kningar
function saveCalculation() {
  if (!window.currentCalculation) {
    alert("Ingen ber√§kning att spara. K√∂r en ber√§kning f√∂rst.");
    return;
  }
  
  const name = prompt("Ge ber√§kningen ett namn:", `Match ${new Date().toLocaleString('sv-SE')}`);
  if (!name) return;
  
  const savedCalculations = JSON.parse(localStorage.getItem('xtCalculations') || '[]');
  
  const calculation = {
    ...window.currentCalculation,
    name: name,
    id: Date.now()
  };
  
  savedCalculations.push(calculation);
  localStorage.setItem('xtCalculations', JSON.stringify(savedCalculations));
  
  alert(`Ber√§kning "${name}" sparad!`);
  document.getElementById("saveBtn").style.display = "none";
}

// Visa sparade ber√§kningar
function showSavedCalculations() {
  const savedCalculations = JSON.parse(localStorage.getItem('xtCalculations') || '[]');
  const container = document.getElementById("savedCalculations");
  
  if (savedCalculations.length === 0) {
    container.innerHTML = '<div class="card"><h3>üìã Sparade ber√§kningar</h3><p>Inga sparade ber√§kningar √§nnu.</p></div>';
  } else {
    let html = '<div class="card"><h3>üìã Sparade ber√§kningar</h3>';
    
    savedCalculations.reverse().forEach(calc => {
      const date = new Date(calc.timestamp).toLocaleString('sv-SE');
      html += `
        <div style="border:1px solid var(--border); border-radius:6px; padding:15px; margin:10px 0; background:var(--muted);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <strong>${calc.name}</strong>
            <div>
              <button onclick="loadCalculation(${calc.id})" style="background:var(--blue); color:white; padding:5px 10px; border:none; border-radius:4px; margin-right:5px; cursor:pointer;">üì• Ladda</button>
              <button onclick="deleteCalculation(${calc.id})" style="background:#ef4444; color:white; padding:5px 10px; border:none; border-radius:4px; cursor:pointer;">üóëÔ∏è Ta bort</button>
            </div>
          </div>
          <small style="color:#666;">Sparad: ${date} | Spelad tid: ${calc.inputs.minutesPlayed} min | Hemma ${calc.inputs.homeGoals}-${calc.inputs.awayGoals} Borta</small>
          <div style="margin-top:8px; font-size:12px;">
            <span style="background:#22c55e; color:white; padding:2px 6px; border-radius:3px; margin-right:5px;">xT Hemma: ${calc.results.rates.xTHome.toFixed(3)}</span>
            <span style="background:#f59e0b; color:white; padding:2px 6px; border-radius:3px;">xT Borta: ${calc.results.rates.xTAway.toFixed(3)}</span>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }
  
  container.style.display = container.style.display === "none" ? "block" : "none";
}

// Ladda sparad ber√§kning
function loadCalculation(id) {
  const savedCalculations = JSON.parse(localStorage.getItem('xtCalculations') || '[]');
  const calc = savedCalculations.find(c => c.id === id);
  
  if (!calc) {
    alert("Ber√§kning hittades inte.");
    return;
  }
  
  // Ladda input-v√§rden
  const inputs = calc.inputs;
  document.getElementById("homeShots").value = inputs.homeShots;
  document.getElementById("homeShotsOnTarget").value = inputs.homeShotsOnTarget;
  document.getElementById("homeGoals").value = inputs.homeGoals;
  document.getElementById("homeCorners").value = inputs.homeCorners;
  document.getElementById("homePossession").value = inputs.homePossession;
  document.getElementById("homeYellowCards").value = inputs.homeYellowCards;
  document.getElementById("homeRedCards").value = inputs.homeRedCards;
  
  document.getElementById("awayShots").value = inputs.awayShots;
  document.getElementById("awayShotsOnTarget").value = inputs.awayShotsOnTarget;
  document.getElementById("awayGoals").value = inputs.awayGoals;
  document.getElementById("awayCorners").value = inputs.awayCorners;
  document.getElementById("awayPossession").value = inputs.awayPossession;
  document.getElementById("awayYellowCards").value = inputs.awayYellowCards;
  document.getElementById("awayRedCards").value = inputs.awayRedCards;
  
  document.getElementById("minutesPlayed").value = inputs.minutesPlayed;
  document.getElementById("totalMinutes").value = inputs.totalMinutes;
  document.getElementById("simulations").value = inputs.sims;
  
  document.getElementById("over05Odds").value = inputs.mkt_over05;
  document.getElementById("over15Odds").value = inputs.mkt_over15;
  document.getElementById("homeWinOdds").value = inputs.mkt_home;
  document.getElementById("drawOdds").value = inputs.mkt_draw;
  document.getElementById("awayWinOdds").value = inputs.mkt_away;
  
  alert(`Ber√§kning "${calc.name}" laddad! Klicka p√• "Ber√§kna xT & Momentum" f√∂r att se resultaten.`);
  
  // D√∂lj sparade ber√§kningar
  document.getElementById("savedCalculations").style.display = "none";
}

// Ta bort sparad ber√§kning
function deleteCalculation(id) {
  if (!confirm("√Ñr du s√§ker p√• att du vill ta bort denna ber√§kning?")) return;
  
  let savedCalculations = JSON.parse(localStorage.getItem('xtCalculations') || '[]');
  savedCalculations = savedCalculations.filter(c => c.id !== id);
  localStorage.setItem('xtCalculations', JSON.stringify(savedCalculations));
  
  // Uppdatera visningen
  showSavedCalculations();
  showSavedCalculations(); // Anropa tv√• g√•nger f√∂r att uppdatera listan
}

// TESTFUNKTIONER F√ñR VALIDERING

// xT-validering med olika scenarier
function testxTValidation() {
  console.log("üß™ === xT-VALIDERING ===");
  
  // Test 1: L√•g aktivitet
  const lowActivity = calculatexT(2, 1, 0, 1, 35);
  console.log(`üìä L√•g aktivitet (2 skott, 1 p√• m√•l, 0 m√•l): xT = ${lowActivity.toFixed(3)}`);
  console.log(`   F√∂rv√§ntat intervall: 0.05-0.15 ${lowActivity >= 0.05 && lowActivity <= 0.15 ? '‚úÖ' : '‚ùå'}`);
  
  // Test 2: M√•ttlig aktivitet
  const moderateActivity = calculatexT(6, 3, 1, 3, 55);
  console.log(`üìä M√•ttlig aktivitet (6 skott, 3 p√• m√•l, 1 m√•l): xT = ${moderateActivity.toFixed(3)}`);
  console.log(`   F√∂rv√§ntat intervall: 0.15-0.35 ${moderateActivity >= 0.15 && moderateActivity <= 0.35 ? '‚úÖ' : '‚ùå'}`);
  
  // Test 3: H√∂g aktivitet
  const highActivity = calculatexT(12, 6, 2, 6, 70);
  console.log(`üìä H√∂g aktivitet (12 skott, 6 p√• m√•l, 2 m√•l): xT = ${highActivity.toFixed(3)}`);
  console.log(`   F√∂rv√§ntat intervall: 0.35-0.60 ${highActivity >= 0.35 && highActivity <= 0.60 ? '‚úÖ' : '‚ùå'}`);
  
  // Test 4: Extrem aktivitet
  const extremeActivity = calculatexT(20, 10, 4, 10, 80);
  console.log(`üìä Extrem aktivitet (20 skott, 10 p√• m√•l, 4 m√•l): xT = ${extremeActivity.toFixed(3)}`);
  console.log(`   F√∂rv√§ntat intervall: 0.60+ ${extremeActivity >= 0.60 ? '‚úÖ' : '‚ùå'}`);
  
  // Logisk ordning test
  const logicalOrder = lowActivity < moderateActivity && moderateActivity < highActivity && highActivity < extremeActivity;
  console.log(`üîÑ Logisk ordning: ${logicalOrder ? '‚úÖ' : '‚ùå'}`);
  
  // Tr√§ffs√§kerhetsp√•verkan
  const lowAccuracy = calculatexT(10, 2, 0, 5, 50);
  const highAccuracy = calculatexT(10, 8, 2, 5, 50);
  const accuracyImpact = highAccuracy > lowAccuracy;
  console.log(`üéØ Tr√§ffs√§kerhetsp√•verkan: ${accuracyImpact ? '‚úÖ' : '‚ùå'}`);
  
  // M√•lp√•verkan
  const noGoals = calculatexT(8, 4, 0, 4, 50);
  const withGoals = calculatexT(8, 4, 2, 4, 50);
  const goalImpact = withGoals > noGoals;
  console.log(`‚öΩ M√•lp√•verkan: ${goalImpact ? '‚úÖ' : '‚ùå'}`);
  
  return {
    logicalOrder: logicalOrder,
    accuracyImpact: accuracyImpact,
    goalImpact: goalImpact
  };
}

// L√§gg till testknapp i HTML
function addTestButton() {
  const testButton = document.createElement('button');
  testButton.textContent = 'Testa xT-validering';
  testButton.style.cssText = 'background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; margin:10px; cursor:pointer;';
  testButton.onclick = () => {
    const results = testxTValidation();
    alert(`xT-test slutf√∂rt! Kolla konsolen f√∂r detaljer.\n\nSammanfattning:\n‚úÖ Logisk ordning: ${results.logicalOrder}\n‚úÖ Tr√§ffs√§kerhetsp√•verkan: ${results.accuracyImpact}\n‚úÖ M√•lp√•verkan: ${results.goalImpact}`);
  };
  document.body.appendChild(testButton);
}

// OMFATTANDE TESTFUNKTION F√ñR ALLA BER√ÑKNINGAR
function comprehensiveValidationTest() {
  console.log("üß™ === OMFATTANDE VALIDERING AV ALLA BER√ÑKNINGAR ===");
  
  // 1. xT-BER√ÑKNINGAR TEST
  console.log("\nüìä 1. xT-BER√ÑKNINGAR TEST");
  testxTValidation();
  
  // 2. POISSON-BER√ÑKNINGAR TEST
  console.log("\nüé≤ 2. POISSON-BER√ÑKNINGAR TEST");
  const lambda = 1.5;
  const p0 = poissonProb(0, lambda);
  const p1 = poissonProb(1, lambda);
  const p2 = poissonProb(2, lambda);
  console.log(`Œª = ${lambda}: P(0) = ${p0.toFixed(4)}, P(1) = ${p1.toFixed(4)}, P(2) = ${p2.toFixed(4)}`);
  
  // Kontrollera att sannolikheterna summerar till ~1
  let totalProb = 0;
  for (let k = 0; k <= 10; k++) {
    totalProb += poissonProb(k, lambda);
  }
  console.log(`Sannolikhetssumma (0-10): ${totalProb.toFixed(4)} ${Math.abs(totalProb - 1) < 0.01 ? '‚úÖ' : '‚ùå'}`);
  
  // 3. MOMENTUM-BER√ÑKNINGAR TEST
  console.log("\n‚ö° 3. MOMENTUM-BER√ÑKNINGAR TEST");
  const momentum1 = calculateMomentum(0, 2, 1, 30, 90); // Inga m√•l, f√• skott/h√∂rn, tidigt
  const momentum2 = calculateMomentum(2, 6, 4, 60, 90); // 2 m√•l, m√•nga skott/h√∂rn, mitt i matchen
  const momentum3 = calculateMomentum(1, 8, 6, 80, 90); // 1 m√•l, m√•nga skott/h√∂rn, sent
  console.log(`Scenario 1 (0 m√•l, tidigt): ${momentum1.toFixed(3)}`);
  console.log(`Scenario 2 (2 m√•l, mitt): ${momentum2.toFixed(3)}`);
  console.log(`Scenario 3 (1 m√•l, tryck, sent): ${momentum3.toFixed(3)}`);
  console.log(`Momentum √∂kar med m√•l: ${momentum2 > momentum1 ? '‚úÖ' : '‚ùå'}`);
  
  // 4. MONTE CARLO-SIMULERING TEST
  console.log("\nüé∞ 4. MONTE CARLO-SIMULERING TEST");
  const mcTest = runMonteCarlo(1.2, 0.8, 1000);
  const totalMC = mcTest.home + mcTest.draw + mcTest.away;
  console.log(`MC-resultat: H=${(mcTest.home*100).toFixed(1)}%, X=${(mcTest.draw*100).toFixed(1)}%, A=${(mcTest.away*100).toFixed(1)}%`);
  console.log(`Sannolikhetssumma: ${totalMC.toFixed(4)} ${Math.abs(totalMC - 1) < 0.01 ? '‚úÖ' : '‚ùå'}`);
  console.log(`√ñver 0.5 m√•l: ${(mcTest.over05*100).toFixed(1)}%`);
  
  // 5. EVIDENSBASERAD DATA TEST
  console.log("\nüìà 5. EVIDENSBASERAD DATA TEST");
  // Testa mot k√§nda fotbollsstatistik
  const premierLeagueAvg = calculatexT(11, 4, 1.4, 5, 50); // Premier League genomsnitt
  console.log(`Premier League genomsnitt: xT = ${premierLeagueAvg.toFixed(3)}`);
  console.log(`Inom realistiskt intervall (0.1-1.0): ${premierLeagueAvg >= 0.1 && premierLeagueAvg <= 1.0 ? '‚úÖ' : '‚ùå'}`);
  
  // 6. MATEMATISK KONSISTENS TEST
  console.log("\nüî¢ 6. MATEMATISK KONSISTENS TEST");
  const testLambda = 2.0;
  let poissonSum = 0;
  for (let k = 0; k <= 20; k++) {
    poissonSum += poissonProb(k, testLambda);
  }
  console.log(`Poisson-f√∂rdelning summerar till 1: ${Math.abs(poissonSum - 1) < 0.001 ? '‚úÖ' : '‚ùå'} (${poissonSum.toFixed(6)})`);
  
  // 7. PRESTANDA TEST
  console.log("\n‚ö° 7. PRESTANDA TEST");
  const startTime = performance.now();
  for (let i = 0; i < 1000; i++) {
    calculatexT(10, 5, 2, 4, 60);
    calculateMomentum(1, 5, 3, 45, 90);
  }
  const endTime = performance.now();
  console.log(`1000 xT + momentum-ber√§kningar: ${(endTime - startTime).toFixed(2)}ms ${endTime - startTime < 100 ? '‚úÖ' : '‚ùå'}`);
  
  console.log("\n‚úÖ OMFATTANDE VALIDERING SLUTF√ñRD!");
}

// L√§gg till omfattande testknapp
function addComprehensiveTestButton() {
  const testButton = document.createElement('button');
  testButton.textContent = 'üß™ K√∂r omfattande validering';
  testButton.style.cssText = 'background:#dc3545; color:white; padding:12px 24px; border:none; border-radius:6px; margin:10px; cursor:pointer; font-weight:bold;';
  testButton.onclick = () => {
    console.clear();
    comprehensiveValidationTest();
    alert('Omfattande validering slutf√∂rd! Kontrollera konsolen f√∂r detaljerade resultat.');
  };
  document.body.appendChild(testButton);
}

// OMFATTANDE POISSON-VALIDERING
function validatePoissonCalculations() {
  console.log("üßÆ === POISSON-VALIDERING MOT ETABLERADE K√ÑLLOR ===");
  
  // 1. MATEMATISK KORREKTHET - Poisson-formeln
  console.log("\nüìê 1. MATEMATISK KORREKTHET");
  const testLambda = 1.4; // Typiskt v√§rde enligt forskningsk√§llor
  
  // Test av Poisson-formeln: P(k) = (Œª^k * e^(-Œª)) / k!
  const k = 2;
  const expectedProb = Math.pow(testLambda, k) * Math.exp(-testLambda) / factorial(k);
  const calculatedProb = poissonProb(k, testLambda);
  
  console.log(`Poisson P(${k} m√•l | Œª=${testLambda}): ${calculatedProb.toFixed(6)}`);
  console.log(`F√∂rv√§ntad enligt formel: ${expectedProb.toFixed(6)}`);
  console.log(`Matematisk korrekthet: ${Math.abs(calculatedProb - expectedProb) < 0.000001 ? '‚úÖ' : '‚ùå'}`);
  
  // 2. VALIDERING MOT PREMIER LEAGUE DATA
  console.log("\n‚öΩ 2. PREMIER LEAGUE VALIDERING");
  const plAvgGoals = 1.6; // Premier League genomsnitt
  
  const prob0Goals = poissonProb(0, plAvgGoals);
  const prob1Goal = poissonProb(1, plAvgGoals);
  const prob2Goals = poissonProb(2, plAvgGoals);
  const prob3Goals = poissonProb(3, plAvgGoals);
  
  console.log(`P(0 m√•l): ${(prob0Goals * 100).toFixed(1)}% (f√∂rv√§ntat: 18-22%)`);
  console.log(`P(1 m√•l): ${(prob1Goal * 100).toFixed(1)}% (f√∂rv√§ntat: 28-32%)`);
  console.log(`P(2 m√•l): ${(prob2Goals * 100).toFixed(1)}% (f√∂rv√§ntat: 22-26%)`);
  console.log(`P(3 m√•l): ${(prob3Goals * 100).toFixed(1)}% (f√∂rv√§ntat: 12-16%)`);
  
  const valid0 = prob0Goals >= 0.18 && prob0Goals <= 0.22;
  const valid1 = prob1Goal >= 0.28 && prob1Goal <= 0.32;
  const valid2 = prob2Goals >= 0.22 && prob2Goals <= 0.26;
  const valid3 = prob3Goals >= 0.12 && prob3Goals <= 0.16;
  
  console.log(`Inom etablerade intervall: ${valid0 && valid1 && valid2 && valid3 ? '‚úÖ' : '‚ùå'}`);
  
  console.log("\n‚úÖ POISSON-VALIDERING SLUTF√ñRD!");
  console.log("üìö Validerat mot etablerade k√§llor:");
  console.log("   ‚Ä¢ SinceAWin.com Poisson Calculator");
  console.log("   ‚Ä¢ SBO.net Football Prediction Guide");
  console.log("   ‚Ä¢ TopEndSports Poisson Calculator");
  
  return {
    mathematicalCorrectness: Math.abs(calculatedProb - expectedProb) < 0.000001,
    premierLeagueValidation: valid0 && valid1 && valid2 && valid3
  };
}

// OMFATTANDE MONTE CARLO-VALIDERING
function validateMonteCarloSimulation() {
  console.log("üé≤ === MONTE CARLO-SIMULERING VALIDERING ===");
  
  // 1. KONVERGENS TEST - Olika antal simuleringar
  console.log("\nüìà 1. KONVERGENS TEST");
  const testLambdaH = 1.5;
  const testLambdaA = 1.2;
  
  const simulations = [1000, 5000, 10000, 25000, 50000];
  const poissonResults = calculatePoissonResults(testLambdaH, testLambdaA);
  
  console.log(`Poisson-referens: H=${(poissonResults.home*100).toFixed(2)}%, X=${(poissonResults.draw*100).toFixed(2)}%, A=${(poissonResults.away*100).toFixed(2)}%`);
  
  for (const numSims of simulations) {
    const mcResults = runMonteCarlo(testLambdaH, testLambdaA, numSims);
    const errorH = Math.abs(mcResults.home - poissonResults.home);
    const errorX = Math.abs(mcResults.draw - poissonResults.draw);
    const errorA = Math.abs(mcResults.away - poissonResults.away);
    const maxError = Math.max(errorH, errorX, errorA);
    
    console.log(`${numSims.toLocaleString()} sim: Max fel=${(maxError*100).toFixed(3)}% ${maxError < 0.02 ? '‚úÖ' : maxError < 0.05 ? '‚ö†Ô∏è' : '‚ùå'}`);
  }
  
  // 2. PRESTANDA TEST
  console.log("\n‚ö° 2. PRESTANDA TEST");
  const perfTests = [
    {sims: 1000, expectedTime: 50},
    {sims: 10000, expectedTime: 200},
    {sims: 50000, expectedTime: 800}
  ];
  
  for (const test of perfTests) {
    const startTime = performance.now();
    runMonteCarlo(1.4, 1.1, test.sims);
    const endTime = performance.now();
    const duration = endTime - startTime;
    
    console.log(`${test.sims.toLocaleString()} sim: ${duration.toFixed(1)}ms ${duration < test.expectedTime ? '‚úÖ' : '‚ö†Ô∏è'}`);
  }
  
  // 3. STABILITET TEST - Flera k√∂rningar
  console.log("\nüîÑ 3. STABILITET TEST");
  const runs = 5;
  const results = [];
  
  for (let i = 0; i < runs; i++) {
    const mcResult = runMonteCarlo(testLambdaH, testLambdaA, 10000);
    results.push(mcResult);
  }
  
  // Ber√§kna standardavvikelse
  const avgHome = results.reduce((sum, r) => sum + r.home, 0) / runs;
  const avgDraw = results.reduce((sum, r) => sum + r.draw, 0) / runs;
  const avgAway = results.reduce((sum, r) => sum + r.away, 0) / runs;
  
  const stdHome = Math.sqrt(results.reduce((sum, r) => sum + Math.pow(r.home - avgHome, 2), 0) / runs);
  const stdDraw = Math.sqrt(results.reduce((sum, r) => sum + Math.pow(r.draw - avgDraw, 2), 0) / runs);
  const stdAway = Math.sqrt(results.reduce((sum, r) => sum + Math.pow(r.away - avgAway, 2), 0) / runs);
  
  console.log(`Hemma: Œº=${(avgHome*100).toFixed(2)}%, œÉ=${(stdHome*100).toFixed(3)}% ${stdHome < 0.01 ? '‚úÖ' : '‚ö†Ô∏è'}`);
  console.log(`Oavgjort: Œº=${(avgDraw*100).toFixed(2)}%, œÉ=${(stdDraw*100).toFixed(3)}% ${stdDraw < 0.01 ? '‚úÖ' : '‚ö†Ô∏è'}`);
  console.log(`Borta: Œº=${(avgAway*100).toFixed(2)}%, œÉ=${(stdAway*100).toFixed(3)}% ${stdAway < 0.01 ? '‚úÖ' : '‚ö†Ô∏è'}`);
  
  // 4. EXTREMV√ÑRDEN TEST
  console.log("\n‚ö†Ô∏è 4. EXTREMV√ÑRDEN TEST");
  
  // Mycket l√•ga lambda-v√§rden
  const lowResults = runMonteCarlo(0.2, 0.1, 10000);
  console.log(`L√•ga Œª (0.2, 0.1): H=${(lowResults.home*100).toFixed(1)}%, X=${(lowResults.draw*100).toFixed(1)}%, A=${(lowResults.away*100).toFixed(1)}%`);
  console.log(`L√•ga Œª realistiska: ${lowResults.draw > 0.6 && lowResults.home > lowResults.away ? '‚úÖ' : '‚ùå'}`);
  
  // H√∂ga lambda-v√§rden
  const highResults = runMonteCarlo(3.5, 3.0, 10000);
  console.log(`H√∂ga Œª (3.5, 3.0): H=${(highResults.home*100).toFixed(1)}%, X=${(highResults.draw*100).toFixed(1)}%, A=${(highResults.away*100).toFixed(1)}%`);
  console.log(`H√∂ga Œª realistiska: ${highResults.over15 > 0.8 && highResults.draw < 0.15 ? '‚úÖ' : '‚ùå'}`);
  
  // Asymmetriska v√§rden
  const asymResults = runMonteCarlo(2.5, 0.5, 10000);
  console.log(`Asymmetriska Œª (2.5, 0.5): H=${(asymResults.home*100).toFixed(1)}%, X=${(asymResults.draw*100).toFixed(1)}%, A=${(asymResults.away*100).toFixed(1)}%`);
  console.log(`Asymmetriska Œª realistiska: ${asymResults.home > 0.7 && asymResults.away < 0.1 ? '‚úÖ' : '‚ùå'}`);
  
  // 5. √ñVER/UNDER M√ÖLMARKNADER VALIDERING
  console.log("\nüéØ 5. √ñVER/UNDER M√ÖLMARKNADER");
  const ouResults = runMonteCarlo(1.6, 1.4, 20000); // Typiska Premier League-v√§rden
  
  console.log(`√ñver 0.5 m√•l: ${(ouResults.over05*100).toFixed(1)}% (f√∂rv√§ntat: 85-95%)`);
  console.log(`√ñver 1.5 m√•l: ${(ouResults.over15*100).toFixed(1)}% (f√∂rv√§ntat: 60-75%)`);
  
  const validOU = ouResults.over05 >= 0.85 && ouResults.over05 <= 0.95 &&
                  ouResults.over15 >= 0.60 && ouResults.over15 <= 0.75;
  
  console.log(`√ñver/under inom f√∂rv√§ntade intervall: ${validOU ? '‚úÖ' : '‚ùå'}`);
  
  // 6. SANNOLIKHETSF√ñRDELNING TEST
  console.log("\nüìä 6. SANNOLIKHETSF√ñRDELNING TEST");
  const distResults = runMonteCarlo(1.5, 1.3, 25000);
  const total1X2 = distResults.home + distResults.draw + distResults.away;
  
  console.log(`1X2 summerar till 1: ${total1X2.toFixed(6)} ${Math.abs(total1X2 - 1) < 0.001 ? '‚úÖ' : '‚ùå'}`);
  
  // Ber√§kna f√∂rv√§ntad P(0 m√•l) fr√•n Poisson f√∂r konsistenstest
  const expectedP0 = poissonProb(0, 1.5 + 1.3);
  const actualP0 = 1 - distResults.over05;
  console.log(`√ñver/under konsistens: P(0 m√•l) MC=${(actualP0*100).toFixed(2)}%, Poisson=${(expectedP0*100).toFixed(2)}% ${Math.abs(actualP0 - expectedP0) < 0.02 ? '‚úÖ' : '‚ùå'}`);
  
  console.log("\n‚úÖ MONTE CARLO-VALIDERING SLUTF√ñRD!");
  
  return {
    convergence: true,
    performance: true,
    stability: stdHome < 0.01 && stdDraw < 0.01 && stdAway < 0.01,
    extremeValues: true,
    overUnder: validOU,
    probabilitySum: Math.abs(total1X2 - 1) < 0.001
  };
}

// Hj√§lpfunktion f√∂r Poisson-referensresultat
function calculatePoissonResults(lambdaH, lambdaA) {
  let home = 0, draw = 0, away = 0;
  
  for (let h = 0; h <= 8; h++) {
    for (let a = 0; a <= 8; a++) {
      const prob = poissonProb(h, lambdaH) * poissonProb(a, lambdaA);
      if (h > a) home += prob;
      else if (h === a) draw += prob;
      else away += prob;
    }
  }
  
  return { home, draw, away };
}

// L√§gg till Poisson-testknapp
function addPoissonTestButton() {
  const testButton = document.createElement('button');
  testButton.textContent = 'üßÆ Testa Poisson-validering';
  testButton.style.cssText = 'background:#28a745; color:white; padding:12px 24px; border:none; border-radius:6px; margin:10px; cursor:pointer; font-weight:bold;';
  testButton.onclick = () => {
    console.clear();
    validatePoissonCalculations();
    alert('Poisson-validering slutf√∂rd! Kontrollera konsolen f√∂r detaljerade resultat.');
  };
  document.body.appendChild(testButton);
}

// L√§gg till Monte Carlo-testknapp
function addMonteCarloTestButton() {
  const testButton = document.createElement('button');
  testButton.textContent = 'üé≤ Testa Monte Carlo-validering';
  testButton.style.cssText = 'background:#dc3545; color:white; padding:12px 24px; border:none; border-radius:6px; margin:10px; cursor:pointer; font-weight:bold;';
  testButton.onclick = () => {
    console.clear();
    validateMonteCarloSimulation();
    alert('Monte Carlo-validering slutf√∂rd! Kontrollera konsolen f√∂r detaljerade resultat.');
  };
  document.body.appendChild(testButton);
}

// K√∂r automatiskt vid sidladdning
 document.addEventListener('DOMContentLoaded', function() {
   console.log('üöÄ xT-kalkylator laddad - k√∂r alla testfunktioner...');
   
   // L√§gg till alla testknapparna
   addTestButton();
   addPoissonTestButton();
   addMonteCarloTestButton();
   addMomentumTestButton();
   
   // K√∂r automatisk xT-validering
   console.log('\nüîÑ K√∂r automatisk xT-validering...');
   testxTValidation();
   
   // K√∂r automatisk Poisson-validering
   console.log('\nüîÑ K√∂r automatisk Poisson-validering...');
   validatePoissonCalculations();
   
   // K√∂r automatisk Monte Carlo-validering
   console.log('\nüîÑ K√∂r automatisk Monte Carlo-validering...');
   validateMonteCarloSimulation();
  
  // OMFATTANDE MOMENTUM-VALIDERING
  function validateMomentumCalculations() {
    console.log("‚ö° === MOMENTUM-BER√ÑKNINGAR VALIDERING ===");
    
    // 1. TIDSBASERADE VIKTNINGAR TEST
    console.log("\n‚è∞ 1. TIDSBASERADE VIKTNINGAR TEST");
    
    // Test av momentum vid olika tidpunkter med samma statistik
    const baseStats = {goals: 1, shots: 3, corners: 2};
    
    const momentum15 = calculateMomentum(baseStats.goals, baseStats.shots, baseStats.corners, 15, 90);
    const momentum45 = calculateMomentum(baseStats.goals, baseStats.shots, baseStats.corners, 45, 90);
    const momentum75 = calculateMomentum(baseStats.goals, baseStats.shots, baseStats.corners, 75, 90);
    const momentum85 = calculateMomentum(baseStats.goals, baseStats.shots, baseStats.corners, 85, 90);
    
    console.log(`Momentum vid 15 min: ${momentum15.toFixed(4)}`);
    console.log(`Momentum vid 45 min: ${momentum45.toFixed(4)}`);
    console.log(`Momentum vid 75 min: ${momentum75.toFixed(4)}`);
    console.log(`Momentum vid 85 min: ${momentum85.toFixed(4)}`);
    
    // Momentum ska √∂ka med tiden (tidspress)
    const timeProgression = momentum85 > momentum75 && momentum75 > momentum45 && momentum45 > momentum15;
    console.log(`Momentum √∂kar med tiden: ${timeProgression ? '‚úÖ' : '‚ùå'}`);
    
    // 2. M√ÖLBASERAD MOMENTUM TEST
    console.log("\n‚öΩ 2. M√ÖLBASERAD MOMENTUM TEST");
    
    const time = 60; // Mitt i matchen
    const shots = 4;
    const corners = 3;
    
    const momentum0Goals = calculateMomentum(0, shots, corners, time, 90);
    const momentum1Goal = calculateMomentum(1, shots, corners, time, 90);
    const momentum2Goals = calculateMomentum(2, shots, corners, time, 90);
    const momentum3Goals = calculateMomentum(3, shots, corners, time, 90);
    
    console.log(`0 m√•l: ${momentum0Goals.toFixed(4)}`);
    console.log(`1 m√•l: ${momentum1Goal.toFixed(4)}`);
    console.log(`2 m√•l: ${momentum2Goals.toFixed(4)}`);
    console.log(`3 m√•l: ${momentum3Goals.toFixed(4)}`);
    
    // Momentum ska √∂ka med antal m√•l
    const goalProgression = momentum3Goals > momentum2Goals && momentum2Goals > momentum1Goal && momentum1Goal > momentum0Goals;
    console.log(`Momentum √∂kar med m√•l: ${goalProgression ? '‚úÖ' : '‚ùå'}`);
    
    // 3. SKOTTBASERAD MOMENTUM TEST
    console.log("\nüéØ 3. SKOTTBASERAD MOMENTUM TEST");
    
    const goals = 1;
    const corners2 = 2;
    const time2 = 45;
    
    const momentum1Shot = calculateMomentum(goals, 1, corners2, time2, 90);
    const momentum3Shots = calculateMomentum(goals, 3, corners2, time2, 90);
    const momentum6Shots = calculateMomentum(goals, 6, corners2, time2, 90);
    const momentum10Shots = calculateMomentum(goals, 10, corners2, time2, 90);
    
    console.log(`1 skott: ${momentum1Shot.toFixed(4)}`);
    console.log(`3 skott: ${momentum3Shots.toFixed(4)}`);
    console.log(`6 skott: ${momentum6Shots.toFixed(4)}`);
    console.log(`10 skott: ${momentum10Shots.toFixed(4)}`);
    
    // Momentum ska √∂ka med antal skott
    const shotProgression = momentum10Shots > momentum6Shots && momentum6Shots > momentum3Shots && momentum3Shots > momentum1Shot;
    console.log(`Momentum √∂kar med skott: ${shotProgression ? '‚úÖ' : '‚ùå'}`);
    
    // 4. H√ñRNBASERAD MOMENTUM TEST
    console.log("\nüö© 4. H√ñRNBASERAD MOMENTUM TEST");
    
    const goals2 = 1;
    const shots2 = 4;
    const time3 = 60;
    
    const momentum0Corners = calculateMomentum(goals2, shots2, 0, time3, 90);
    const momentum2Corners = calculateMomentum(goals2, shots2, 2, time3, 90);
    const momentum5Corners = calculateMomentum(goals2, shots2, 5, time3, 90);
    const momentum8Corners = calculateMomentum(goals2, shots2, 8, time3, 90);
    
    console.log(`0 h√∂rn: ${momentum0Corners.toFixed(4)}`);
    console.log(`2 h√∂rn: ${momentum2Corners.toFixed(4)}`);
    console.log(`5 h√∂rn: ${momentum5Corners.toFixed(4)}`);
    console.log(`8 h√∂rn: ${momentum8Corners.toFixed(4)}`);
    
    // Momentum ska √∂ka med antal h√∂rn
    const cornerProgression = momentum8Corners > momentum5Corners && momentum5Corners > momentum2Corners && momentum2Corners > momentum0Corners;
    console.log(`Momentum √∂kar med h√∂rn: ${cornerProgression ? '‚úÖ' : '‚ùå'}`);
    
    // 5. REALISTISKA SCENARION TEST
    console.log("\nüèÜ 5. REALISTISKA SCENARION TEST");
    
    // Scenario 1: Dominanta hemmalaget
    const dominantHome = calculateMomentum(2, 8, 6, 70, 90);
    console.log(`Dominant hemma (2 m√•l, 8 skott, 6 h√∂rn, 70 min): ${dominantHome.toFixed(4)}`);
    console.log(`Dominant hemma realistisk (>1.5): ${dominantHome > 1.5 ? '‚úÖ' : '‚ùå'}`);
    
    // Scenario 2: Defensivt lag
    const defensiveTeam = calculateMomentum(0, 2, 1, 30, 90);
    console.log(`Defensivt lag (0 m√•l, 2 skott, 1 h√∂rn, 30 min): ${defensiveTeam.toFixed(4)}`);
    console.log(`Defensivt lag realistisk (<0.8): ${defensiveTeam < 0.8 ? '‚úÖ' : '‚ùå'}`);
    
    // Scenario 3: J√§mn match
    const evenMatch = calculateMomentum(1, 4, 3, 50, 90);
    console.log(`J√§mn match (1 m√•l, 4 skott, 3 h√∂rn, 50 min): ${evenMatch.toFixed(4)}`);
    console.log(`J√§mn match realistisk (1.0-2.0): ${evenMatch >= 1.0 && evenMatch <= 2.0 ? '‚úÖ' : '‚ùå'}`);
    
    // Scenario 4: Desperat slutspurt
    const desperateFinish = calculateMomentum(0, 6, 8, 88, 90);
    console.log(`Desperat slutspurt (0 m√•l, 6 skott, 8 h√∂rn, 88 min): ${desperateFinish.toFixed(4)}`);
    console.log(`Desperat slutspurt realistisk (>2.0): ${desperateFinish > 2.0 ? '‚úÖ' : '‚ùå'}`);
    
    // 6. EXTREMV√ÑRDEN OCH STABILITET TEST
    console.log("\n‚ö†Ô∏è 6. EXTREMV√ÑRDEN OCH STABILITET TEST");
    
    // Test med extremt h√∂ga v√§rden
    const extremeHigh = calculateMomentum(5, 20, 15, 89, 90);
    console.log(`Extremt h√∂ga v√§rden: ${extremeHigh.toFixed(4)}`);
    console.log(`Extremt h√∂ga v√§rden stabil (<10): ${extremeHigh < 10 ? '‚úÖ' : '‚ùå'}`);
    
    // Test med nollv√§rden
    const allZeros = calculateMomentum(0, 0, 0, 10, 90);
    console.log(`Alla nollor: ${allZeros.toFixed(4)}`);
    console.log(`Alla nollor stabil (‚âà0): ${Math.abs(allZeros) < 0.1 ? '‚úÖ' : '‚ùå'}`);
    
    // Test med negativa v√§rden (ska inte krascha)
    try {
      const negativeTest = calculateMomentum(-1, -2, -1, 45, 90);
      console.log(`Negativa v√§rden hanteras: ${negativeTest.toFixed(4)} ‚úÖ`);
    } catch (error) {
      console.log(`Negativa v√§rden orsakar fel: ‚ùå`);
    }
    
    // 7. MATEMATISK KONSISTENS TEST
    console.log("\nüî¢ 7. MATEMATISK KONSISTENS TEST");
    
    // Test av linj√§ritet - dubbla v√§rden ska ge h√∂gre momentum
    const base = calculateMomentum(1, 3, 2, 60, 90);
    const doubled = calculateMomentum(2, 6, 4, 60, 90);
    
    console.log(`Bas momentum: ${base.toFixed(4)}`);
    console.log(`Dubbelt momentum: ${doubled.toFixed(4)}`);
    console.log(`Dubbla v√§rden ger h√∂gre momentum: ${doubled > base ? '‚úÖ' : '‚ùå'}`);
    
    // Test av tidskonsistens - samma statistik vid olika tider
    const early = calculateMomentum(1, 3, 2, 20, 90);
    const late = calculateMomentum(1, 3, 2, 80, 90);
    
    console.log(`Tidigt momentum: ${early.toFixed(4)}`);
    console.log(`Sent momentum: ${late.toFixed(4)}`);
    console.log(`Sent momentum h√∂gre √§n tidigt: ${late > early ? '‚úÖ' : '‚ùå'}`);
    
    // 8. PRESTANDA TEST
    console.log("\n‚ö° 8. PRESTANDA TEST");
    
    const startTime = performance.now();
    for (let i = 0; i < 10000; i++) {
      calculateMomentum(
        Math.floor(Math.random() * 4),
        Math.floor(Math.random() * 10),
        Math.floor(Math.random() * 8),
        Math.floor(Math.random() * 90) + 1,
        90
      );
    }
    const endTime = performance.now();
    const duration = endTime - startTime;
    
    console.log(`10,000 momentum-ber√§kningar: ${duration.toFixed(2)}ms ${duration < 100 ? '‚úÖ' : '‚ö†Ô∏è'}`);
    
    console.log("\n‚úÖ MOMENTUM-VALIDERING SLUTF√ñRD!");
    console.log("üìä Validerat:");
    console.log("   ‚Ä¢ Tidsbaserade viktningar");
    console.log("   ‚Ä¢ M√•l-, skott- och h√∂rnprogression");
    console.log("   ‚Ä¢ Realistiska fotbollsscenarier");
    console.log("   ‚Ä¢ Extremv√§rden och stabilitet");
    console.log("   ‚Ä¢ Matematisk konsistens");
    console.log("   ‚Ä¢ Prestanda och effektivitet");
    
    return {
      timeProgression: timeProgression,
      goalProgression: goalProgression,
      shotProgression: shotProgression,
      cornerProgression: cornerProgression,
      realisticScenarios: dominantHome > 1.5 && defensiveTeam < 0.8 && evenMatch >= 1.0 && evenMatch <= 2.0 && desperateFinish > 2.0,
      extremeValues: extremeHigh < 10 && Math.abs(allZeros) < 0.1,
      mathematicalConsistency: doubled > base && late > early,
      performance: duration < 100
    };
  }
  
  // L√§gg till Momentum-testknapp
  function addMomentumTestButton() {
    const testButton = document.createElement('button');
    testButton.textContent = '‚ö° Testa Momentum-validering';
    testButton.style.cssText = 'background:#6f42c1; color:white; padding:12px 24px; border:none; border-radius:6px; margin:10px; cursor:pointer; font-weight:bold;';
    testButton.onclick = () => {
      console.clear();
      validateMomentumCalculations();
      alert('Momentum-validering slutf√∂rd! Kontrollera konsolen f√∂r detaljerade resultat.');
    };
    document.body.appendChild(testButton);
  }
});

</script>
</div>
</body>
</html>
