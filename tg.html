<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bet365 Live xT & Momentum-kalkylator – Expected Threat + Monte Carlo</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    :root {
      --blue:#004aad; --green:#22c55e; --amber:#f59e0b;
      --bg:#f9f9f9; --card:#ffffff; --muted:#eef6ff;
      --border:#e5e7eb; --ink:#1a1a1a;
    }
    body {font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:20px;}
    h1 {color:var(--blue);}
    .grid2 {display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .grid3 {display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .box {background:var(--card); border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:20px;}
    h3 {margin:8px 0 6px; color:var(--blue)}
    label {display:block; margin-top:8px; font-size:14px;}
    input[type=number] {width:100%; padding:6px; margin-top:3px; border:1px solid #ccc; border-radius:6px; font-size:14px;}
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 12px 24px; border-radius: 8px;
      cursor: pointer; font-size: 16px; font-weight: 600;
      transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102,126,234,0.4);
      margin: 5px;
    }
    .btn:hover {transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.6);}
    .btn-row {display: flex; flex-wrap: wrap; justify-content: center; margin: 20px 0; gap: 10px;}
    .result {margin-top:15px; padding:15px; background:var(--muted); border-left:4px solid var(--blue); display:none; border-radius:8px;}
    table {width:100%; border-collapse:collapse; margin-top:6px; font-size:14px;}
    th, td {text-align:left; padding:6px 4px; border-bottom:1px solid var(--border);}
    .pill{background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:13px;}
    .kpi {display:flex; gap:12px; flex-wrap:wrap; margin:6px 0 12px}
    .legend-box {display:inline-block; width:16px; height:16px; margin-right:6px; border:1px solid #333;}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>⚽ Bet365 Live xT & Momentum-kalkylator</h1>

  <div class="grid2">
    <!-- INPUTS -->
    <div class="box">
      <h3>Match & statistik</h3>
      <div class="grid3">
        <label>Minut<input id="minute" type="number" value="78"></label>
        <label>Tillägg<input id="stopp" type="number" value="5"></label>
        <label>MC-simuleringar<input id="sims" type="number" value="10000"></label>
      </div>
      <div class="grid3">
        <label>Hemmalag mål<input id="sh" type="number" value="1"></label>
        <label>Bortalag mål<input id="sa" type="number" value="1"></label>
        <label>Gula kort<input id="yc" type="number" value="3"></label>
      </div>
      <div class="grid3">
        <label>Röda Hemma<input id="red_h" type="number" value="0"></label>
        <label>Röda Borta<input id="red_a" type="number" value="0"></label>
      </div>

      <h3>Bet365 totalsiffror</h3>
      <div class="grid3">
        <label>Skott H<input id="shots_h" type="number" value="12"></label>
        <label>Skott på mål H<input id="sot_h" type="number" value="5"></label>
        <label>Hörn H<input id="corners_h" type="number" value="6"></label>
      </div>
      <label>Bollinnehav H<input id="da_h" type="number" value="65"></label>

      <div class="grid3">
        <label>Skott B<input id="shots_a" type="number" value="9"></label>
        <label>Skott på mål B<input id="sot_a" type="number" value="3"></label>
        <label>Hörn B<input id="corners_a" type="number" value="4"></label>
      </div>
      <label>Bollinnehav B<input id="da_a" type="number" value="55"></label>

      <h3>Marknadsodds</h3>
      <div class="grid3">
        <label>Över 0.5<input id="mkt_over05" type="number" step="0.01" value="1.70"></label>
        <label>Över 1.5<input id="mkt_over15" type="number" step="0.01" value="2.30"></label>
        <span></span>
      </div>
      <div class="grid3">
        <label>Hemma<input id="mkt_home" type="number" step="0.01" value="2.20"></label>
        <label>Oavgjort<input id="mkt_draw" type="number" step="0.01" value="3.40"></label>
        <label>Borta<input id="mkt_away" type="number" step="0.01" value="3.10"></label>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="runCalc()">Beräkna</button>
      </div>
    </div>

    <!-- RESULTAT -->
    <div class="box">
      <h3>Resultat & Value-check</h3>
      <div id="out" class="result"></div>
    </div>
  </div>

<script>
function factorial(n){let r=1;for(let i=2;i<=n;i++)r*=i;return r;}
function pois(k,lam){return Math.exp(-lam)*Math.pow(lam,k)/(k?factorial(k):1);}
function fair(p){return p>0?(1/p).toFixed(2):"∞";}

function calculatexT(shots, sot, corners, possession, goals, minute) {
  const shotAccuracy = shots > 0 ? sot / shots : 0;
  const conversionRate = sot > 0 ? goals / sot : 0;
  return shots*0.08 + shotAccuracy*0.15 + conversionRate*0.25 + corners*0.12 + (possession/100)*0.1;
}
function calculateMomentum(goals, xT, minute, red, yellow) {
  const timeWeight = Math.min(1.5,0.5+(minute/90));
  const goalMomentum = goals>0?Math.log(goals+1)*0.3:0;
  const cardPenalty = (red*0.4)+(yellow*0.05);
  return Math.max(0,(xT*timeWeight+goalMomentum)*(1-cardPenalty));
}
function calculateAdvancedRate(home,away,minute){
  const xTH=calculatexT(home.shots,home.sot,home.corners,home.possession,home.goals,minute);
  const xTA=calculatexT(away.shots,away.sot,away.corners,away.possession,away.goals,minute);
  const mH=calculateMomentum(home.goals,xTH,minute,home.red,home.yellow);
  const mA=calculateMomentum(away.goals,xTA,minute,away.red,away.yellow);
  const base=Math.max(0.01,(mH+mA)*0.15);
  const mult=minute>75?1.2:minute<30?0.8:1;
  return {
    homeRate:(mH/(mH+mA+0.01))*base*mult,
    awayRate:(mA/(mH+mA+0.01))*base*mult,
    xTHome:xTH,xTAway:xTA,momentumHome:mH,momentumAway:mA
  };
}
function poissonRandom(lambda){
  if(lambda<30){let L=Math.exp(-lambda),k=0,p=1;do{k++;p*=Math.random();}while(p>L);return k-1;}
  return Math.max(0,Math.round(lambda+Math.sqrt(lambda)*(Math.random()-0.5)*2.5));
}
function runMonteCarlo(lH,lA,sims,sh,sa){
  let no=0,o05=0,o15=0,H=0,X=0,A=0;
  for(let s=0;s<sims;s++){
    const gH=poissonRandom(lH), gA=poissonRandom(lA);
    const fH=sh+gH, fA=sa+gA, tot=gH+gA;
    if(tot===0) no++;
    if(tot>=1) o05++;
    if(tot>=2) o15++;
    if(fH>fA) H++; else if(fH===fA) X++; else A++;
  }
  return {noGoal:no/sims,over05:o05/sims,over15:o15/sims,H:H/sims,X:X/sims,A:A/sims};
}
function valueCheck(mkt,fair){
  const m=parseFloat(mkt),f=parseFloat(fair);
  if(!m||!f||f===Infinity) return "❌";
  const edge=(m-f)/f;
  return (edge>=0.05 && m>=1.40)?"✅":"❌";
}

function runCalc(){
  const gv=id=>parseFloat(document.getElementById(id).value||0);
  const minute=gv("minute"), stopp=gv("stopp"), sims=gv("sims");
  const sh=gv("sh"), sa=gv("sa"), yc=gv("yc"), redH=gv("red_h"), redA=gv("red_a");
  const shotsH=gv("shots_h"), sotH=gv("sot_h"), cornersH=gv("corners_h"), daH=gv("da_h");
  const shotsA=gv("shots_a"), sotA=gv("sot_a"), cornersA=gv("corners_a"), daA=gv("da_a");
  const mkt_over05=gv("mkt_over05"), mkt_over15=gv("mkt_over15");
  const mkt_home=gv("mkt_home"), mkt_draw=gv("mkt_draw"), mkt_away=gv("mkt_away");

  const R=Math.max(0,(90+stopp)-minute);
  const home={shots:shotsH,sot:sotH,corners:cornersH,possession:daH,goals:sh,red:redH,yellow:yc*0.6};
  const away={shots:shotsA,sot:sotA,corners:cornersA,possession:daA,goals:sa,red:redA,yellow:yc*0.4};
  const rates=calculateAdvancedRate(home,away,minute);
  const lamH=rates.homeRate*R, lamA=rates.awayRate*R;

  // Poisson
  let no=0,o05=0,o15=0,H=0,X=0,A=0,MAX=15;
  for(let i=0;i<=MAX;i++){for(let j=0;j<=MAX;j++){
    const p=pois(i,lamH)*pois(j,lamA);
    if(i===0&&j===0) no+=p;
    if(i+j>=1) o05+=p;
    if(i+j>=2) o15+=p;
    const fh=sh+i,fa=sa+j;
    if(fh>fa) H+=p; else if(fh===fa) X+=p; else A+=p;
  }}
  const mc=runMonteCarlo(lamH,lamA,sims,sh,sa);

  const out=document.getElementById("out");
  out.style.display="block";
  out.innerHTML=`
    <div class="kpi">
      <span class="pill">xT H: ${rates.xTHome.toFixed(3)}</span>
      <span class="pill">xT B: ${rates.xTAway.toFixed(3)}</span>
      <span class="pill">Momentum H: ${rates.momentumHome.toFixed(3)}</span>
      <span class="pill">Momentum B: ${rates.momentumAway.toFixed(3)}</span>
    </div>
    <div class="kpi">
      <span class="pill">Förv. mål kvar H: ${lamH.toFixed(2)}</span>
      <span class="pill">Förv. mål kvar B: ${lamA.toFixed(2)}</span>
      <span class="pill">Minuter kvar: ${R}</span>
    </div>
    <h4>Marknadsanalys</h4>
    <table>
      <tr><td>Över 0.5</td><td>${fair(o05)}</td><td>${(1/mc.over05).toFixed(2)}</td><td>${mkt_over05}</td><td>${valueCheck(mkt_over05,fair(o05))}</td></tr>
      <tr><td>Över 1.5</td><td>${fair(o15)}</td><td>${(1/mc.over15).toFixed(2)}</td><td>${mkt_over15}</td><td>${valueCheck(mkt_over15,fair(o15))}</td></tr>
      <tr><td>Hemma</td><td>${fair(H)}</td><td>${(1/mc.H).toFixed(2)}</td><td>${mkt_home}</td><td>${valueCheck(mkt_home,fair(H))}</td></tr>
      <tr><td>Oavgjort</td><td>${fair(X)}</td><td>${(1/mc.X).toFixed(2)}</td><td>${mkt_draw}</td><td>${valueCheck(mkt_draw,fair(X))}</td></tr>
      <tr><td>Borta</td><td>${fair(A)}</td><td>${(1/mc.A).toFixed(2)}</td><td>${mkt_away}</td><td>${valueCheck(mkt_away,fair(A))}</td></tr>
    </table>
    <canvas id="xtHeatmap" width="600" height="400" style="margin-top:20px;border:1px solid #ccc"></canvas>
  `;

  // Rita heatmap
  const ctx=document.getElementById("xtHeatmap").getContext("2d");
  const cols=12,rows=8,cellW=ctx.canvas.width/cols,cellH=ctx.canvas.height/rows;
  const grid=[
    [0,0,0,0.01,0.01,0,0,0],[0,0,0.01,0.01,0.01,0.01,0,0],[0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01],
    [0.01,0.01,0.02,0.02,0.02,0.02,0.01,0.01],[0.02,0.02,0.03,0.03,0.03,0.03,0.02,0.02],[0.03,0.03,0.04,0.05,0.05,0.04,0.03,0.03],
    [0.04,0.05,0.06,0.07,0.07,0.06,0.05,0.04],[0.05,0.06,0.08,0.09,0.09,0.08,0.06,0.05],[0.08,0.1,0.12,0.13,0.13,0.12,0.1,0.08],
    [0.12,0.15,0.18,0.2,0.2,0.18,0.15,0.12],[0.18,0.22,0.26,0.28,0.28,0.26,0.22,0.18],[0.25,0.3,0.35,0.4,0.4,0.35,0.3,0.25]
  ];
  for(let x=0;x<cols;x++){for(let y=0;y<rows;y++){
    const val=grid[x][y],a=val/0.4;
    ctx.fillStyle=`rgba(255,0,0,${a})`;
    ctx.fillRect(x*cellW,(rows-y-1)*cellH,cellW,cellH);
  }}
  function mark(x,y,c="rgba(0,255,0,0.5)"){ctx.fillStyle=c;ctx.fillRect(x*cellW,(rows-y-1)*cellH,cellW,cellH);}
  if(shotsH+shotsA>0){mark(11,3);mark(11,4);mark(11,5);mark(10,4);}
  if(cornersH+cornersA>0){mark(11,0,"rgba(0,0,255,0.5)");mark(11,7,"rgba(0,0,255,0.5)");}
  if(daH+daA>0){mark(5,3,"rgba(255,255,0,0.5)");mark(6,3,"rgba(255,255,0,0.5)");}

  // Legend
  out.innerHTML += `
    <div style="margin-top:10px; font-size:14px;">
      <strong>Legend:</strong><br>
      <div><span class="legend-box" style="background:rgba(0,255,0,0.6)"></span> Skott</div>
      <div><span class="legend-box" style="background:rgba(0,0,255,0.6)"></span> Hörnor</div>
      <div><span class="legend-box" style="background:rgba(255,255,0,0.6)"></span> Bollinnehav</div>
    </div>
  `;
}
</script>
</body>
</html>
